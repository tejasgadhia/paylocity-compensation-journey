<!DOCTYPE html>
<html lang="en" data-theme="artistic" data-view="desktop">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
                   style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                   font-src 'self' https://fonts.gstatic.com;
                   img-src 'self' data:;
                   connect-src 'none';">
    <title>Compensation Journey</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
            crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Optimized: Reduced from 4 families to 2, removed unused weight 500 -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           CSS CUSTOM PROPERTIES - THEMES
           ======================================== */
        
        :root {
            --transition-speed: 0.3s;
        }

        /* TACTICAL THEME (Anduril/Palantir) */
        [data-theme="tactical"] {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #1a1a1d;
            --bg-card: #141416;
            --bg-hover: #1e1e21;
            
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --text-muted: #7a7a7a;  /* Improved contrast: 4.7:1 on #0a0a0b */
            
            --accent-primary: #d4a845;
            --accent-secondary: #45d48a;
            --accent-tertiary: #4598d4;
            --accent-warning: #d45745;
            
            --border-color: #2a2a2d;
            --border-accent: #3a3a3d;
            
            --chart-grid: rgba(255, 255, 255, 0.06);
            --chart-line-1: #d4a845;
            --chart-line-2: #45d48a;
            --chart-fill-1: rgba(212, 168, 69, 0.15);
            --chart-fill-2: rgba(69, 212, 138, 0.15);
            
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --radius-sm: 2px;
            --radius-md: 4px;
            --radius-lg: 6px;
            
            --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.4);
            --shadow-hover: 0 8px 32px rgba(0, 0, 0, 0.6);
            
            --glow-primary: 0 0 20px rgba(212, 168, 69, 0.3);
            --glow-secondary: 0 0 20px rgba(69, 212, 138, 0.3);

            --tooltip-bg: #1a1a1d;
            --tooltip-border: #3a3a3d;
        }

        /* ARTISTIC THEME (Zoho) */
        [data-theme="artistic"] {
            --bg-primary: #faf8f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f2ed;
            --bg-card: #ffffff;
            --bg-hover: #f0ebe3;

            --text-primary: #2d2a26;
            --text-secondary: #5c5650;
            --text-muted: #706a61;  /* Improved contrast: 4.8:1 on #faf8f5 */

            --accent-primary: #e85d04;
            --accent-secondary: #0096c7;
            --accent-tertiary: #7b2cbf;
            --accent-warning: #d00000;

            --border-color: #e8e2da;
            --border-accent: #d4cdc3;

            --chart-grid: rgba(0, 0, 0, 0.06);
            --chart-line-1: #e85d04;
            --chart-line-2: #0096c7;
            --chart-fill-1: rgba(232, 93, 4, 0.12);
            --chart-fill-2: rgba(0, 150, 199, 0.12);

            /* Font optimization: Use Space Grotesk for both display and body (was Libre Baskerville + Nunito) */
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --shadow-card: 0 4px 20px rgba(45, 42, 38, 0.08);
            --shadow-hover: 0 8px 30px rgba(45, 42, 38, 0.12);
            
            --glow-primary: none;
            --glow-secondary: none;

            --tooltip-bg: #ffffff;
            --tooltip-border: #e8e2da;
        }

        /* ========================================
           BASE STYLES
           ======================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
        }

        [data-theme="tactical"] body {
            background-image: 
                linear-gradient(rgba(212, 168, 69, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(212, 168, 69, 0.02) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        [data-theme="artistic"] body {
            background-image: radial-gradient(circle at 100% 0%, rgba(232, 93, 4, 0.03) 0%, transparent 50%),
                              radial-gradient(circle at 0% 100%, rgba(0, 150, 199, 0.03) 0%, transparent 50%);
        }

        /* ========================================
           LANDING PAGE STYLES
           ======================================== */
        
        .landing-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .landing-container {
            display: grid;
            grid-template-columns: 35% 1fr;
            gap: 0;
            width: 80vw;
            max-width: 1400px;
            min-width: 320px;
            height: auto;
            min-height: min(75vh, 600px);
            max-height: calc(100vh - 4rem);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            overflow: auto;
        }

        @media (max-width: 900px) {
            .landing-container {
                grid-template-columns: 1fr;
                width: 90vw;
                height: auto;
                min-height: auto;
                max-height: none;
            }
        }

        @media (min-width: 1800px) {
            .landing-container {
                width: 75vw;
            }
        }

        /* Handle smaller viewport heights */
        @media (max-height: 800px) {
            .landing-page {
                padding: 1rem;
                align-items: flex-start;
            }
            .landing-container {
                max-height: none;
                min-height: auto;
            }
        }

        /* Left Panel */
        .landing-left {
            background: var(--bg-tertiary);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        @media (max-width: 900px) {
            .landing-left {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }

        .landing-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .landing-logo-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-family: var(--font-mono);
            font-size: 0.94rem;
            background: linear-gradient(135deg, var(--accent-primary), #b8942e);
            color: #0a0a0b;
        }

        [data-theme="artistic"] .landing-logo-icon {
            background: linear-gradient(135deg, var(--accent-primary), #ff7b00);
            color: white;
        }

        .landing-logo-text h1 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1.2;
        }

        [data-theme="tactical"] .landing-logo-text h1 {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 1.06rem;
        }

        .landing-logo-text span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .landing-description {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        /* Features List */
        .features-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            font-size: 0.94rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .feature-icon {
            font-size: 1.125rem;
            flex-shrink: 0;
        }

        /* Privacy Badge */
        .privacy-badge {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--accent-secondary);
            border-radius: var(--radius-md);
            padding: 0.875rem;
            margin-top: auto;
        }

        .privacy-icon {
            font-size: 1.375rem;
            flex-shrink: 0;
            line-height: 1;
        }

        .privacy-content h3 {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--accent-secondary);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .privacy-description {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: 1.4;
            margin-bottom: 0.6rem;
        }

        .privacy-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.25rem 0.875rem;
        }

        .privacy-feature {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .privacy-feature .check {
            color: var(--accent-secondary);
            font-weight: bold;
        }

        .privacy-session-warning {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            margin-top: 0.75rem;
            line-height: 1.4;
        }

        .privacy-session-warning strong {
            color: var(--text-primary);
        }

        /* Right Panel */
        .landing-right {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .landing-right-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
            flex-shrink: 0;
        }

        .landing-right-header h2 {
            font-family: var(--font-display);
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        [data-theme="tactical"] .landing-right-header h2 {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 1rem;
        }

        /* Demo CTA */
        .demo-cta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.25rem;
            padding: 0.875rem 1.125rem;
            background: linear-gradient(135deg, rgba(69, 212, 138, 0.1), rgba(69, 152, 212, 0.1));
            border: 1px solid var(--accent-secondary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        [data-theme="artistic"] .demo-cta {
            background: linear-gradient(135deg, rgba(0, 150, 199, 0.1), rgba(123, 44, 191, 0.1));
        }

        .btn-demo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.125rem;
            background: var(--accent-secondary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all var(--transition-speed);
            white-space: nowrap;
        }

        .btn-demo:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(69, 212, 138, 0.3);
        }

        [data-theme="artistic"] .btn-demo:hover {
            box-shadow: 0 4px 12px rgba(0, 150, 199, 0.3);
        }

        .demo-icon {
            font-size: 0.8rem;
        }

        .demo-hint {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .alt-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            padding: 0.5rem 0.7rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            transition: color var(--transition-speed);
        }

        .btn-text:hover {
            color: var(--accent-primary);
        }

        .btn-text-alt {
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: color var(--transition-speed);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .btn-text-alt:hover {
            color: var(--accent-primary);
        }

        .alt-divider {
            color: var(--border-color);
            font-size: 0.875rem;
        }

        /* Inline Instructions */
        .instructions-box {
            padding: 0.875rem 1.125rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 0.875rem;
            flex-shrink: 0;
        }

        .instructions-box .instructions-title {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.6rem;
        }

        .instructions-list {
            margin: 0;
            padding-left: 1.25rem;
            font-size: 0.94rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .instructions-list li {
            margin-bottom: 0.35rem;
            padding-left: 0.25rem;
        }

        .instructions-list li:last-child {
            margin-bottom: 0;
        }

        .instructions-list code {
            background: var(--bg-primary);
            padding: 0.125rem 0.35rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--accent-primary);
        }

        .paste-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
            min-height: 0;
        }

        .paste-area label {
            display: block;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            flex-shrink: 0;
        }

        .paste-area textarea {
            width: 100%;
            flex: 1;
            min-height: 150px;
            max-height: 400px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.875rem;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            line-height: 1.4;
            resize: vertical;  /* Allow vertical resize */
            transition: border-color var(--transition-speed);
        }

        .paste-area textarea:focus {
            border-color: var(--accent-primary);
        }

        .paste-area textarea:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 0;
        }

        .paste-area textarea::placeholder {
            color: var(--text-muted);
        }

        .validation-message {
            margin-top: 0.6rem;
            padding: 0.5rem 0.7rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: var(--font-mono);
            display: none;
            flex-shrink: 0;
        }

        .validation-message.visible {
            display: block;
        }

        .validation-message.success {
            background: rgba(69, 212, 138, 0.15);
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
        }

        .validation-message.error {
            background: rgba(212, 87, 69, 0.1);
            border: 1px solid var(--accent-warning);
            color: var(--accent-warning);
        }

        .validation-message.warning {
            background: rgba(212, 168, 69, 0.15);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
        }

        .landing-footer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.125rem;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .btn {
            padding: 0.7rem 1.5rem;
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            border: 1px solid transparent;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .btn-primary:hover {
            box-shadow: var(--glow-primary);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border-color);
            padding: 0.5rem 0.75rem;
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .file-input {
            display: none;
        }

        /* Theme toggle on landing */
        .landing-theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .landing-theme-btn {
            padding: 0.4rem 0.6rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .landing-theme-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        /* ========================================
           MOBILE SPLASH SCREEN
           ======================================== */
        
        .mobile-splash {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .mobile-splash.active {
            display: flex;
        }

        .mobile-splash-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        .mobile-splash-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .mobile-splash-message {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 320px;
        }

        /* ========================================
           TOOLTIP STYLES
           ======================================== */
        
        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            font-size: 10px;
            color: var(--text-muted);
            cursor: help;
            margin-left: 6px;
            font-family: var(--font-mono);
            font-weight: 600;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .info-tooltip::before {
            content: '?';
        }

        .info-tooltip .tip-text {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--tooltip-bg);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 400;
            line-height: 1.5;
            width: max-content;
            max-width: 280px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            border: 1px solid var(--tooltip-border);
            box-shadow: var(--shadow-card);
            z-index: 9999;
            font-family: var(--font-body);
            text-align: left;
            white-space: normal;
            pointer-events: none;
        }

        .info-tooltip .tip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--tooltip-border);
        }

        .info-tooltip:hover .tip-text {
            opacity: 1;
            visibility: visible;
        }

        .info-tooltip.tip-left .tip-text {
            left: auto;
            right: 0;
            transform: none;
        }

        .info-tooltip.tip-left .tip-text::after {
            left: auto;
            right: 10px;
            transform: none;
        }

        .info-tooltip.tip-right .tip-text {
            left: 0;
            transform: none;
        }

        .info-tooltip.tip-right .tip-text::after {
            left: 10px;
            transform: none;
        }

        /* ========================================
           DEMO BANNER
           ======================================== */
        
        .demo-banner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.6rem 1rem;
            background: linear-gradient(90deg, #d45745, #d4a845);
            color: white;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 200;
        }

        .demo-banner.hidden {
            display: none;
        }

        .demo-banner-icon {
            font-size: 1rem;
        }

        .demo-banner-text {
            text-align: center;
        }

        .demo-banner-text strong {
            font-weight: 700;
        }

        .demo-banner-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            min-width: 32px;  /* Minimum touch target size */
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background var(--transition-speed);
            flex-shrink: 0;
        }

        .demo-banner-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .demo-regenerate-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: all var(--transition-speed);
            white-space: nowrap;
        }

        .demo-regenerate-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.02);
        }

        /* ========================================
           HEADER
           ======================================== */
        
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 300;
            backdrop-filter: blur(10px);
        }

        [data-theme="tactical"] .header {
            background: rgba(17, 17, 19, 0.95);
        }

        [data-theme="artistic"] .header {
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-family: var(--font-mono);
            font-size: 0.75rem;
        }

        [data-theme="tactical"] .logo-icon {
            background: linear-gradient(135deg, var(--accent-primary), #b8942e);
            color: #0a0a0b;
        }

        [data-theme="artistic"] .logo-icon {
            background: linear-gradient(135deg, var(--accent-primary), #ff7b00);
            color: white;
        }

        .logo-text h1 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        [data-theme="tactical"] .logo-text h1 {
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 1rem;
        }

        .logo-text span {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .header-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-switcher {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .theme-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .theme-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .theme-btn:hover:not(.active) {
            background: var(--bg-hover);
        }

        .view-switcher {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .view-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .view-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .view-btn:hover:not(.active) {
            background: var(--bg-hover);
        }

        /* ========================================
           KEYBOARD SHORTCUTS HINT
           ======================================== */
        
        .keyboard-hint {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.5rem 0.75rem;
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-muted);
            box-shadow: var(--shadow-card);
            z-index: 50;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .keyboard-hint:hover {
            opacity: 1;
        }

        .keyboard-hint kbd {
            background: var(--bg-tertiary);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            margin: 0 0.15rem;
        }

        /* ========================================
           MAIN CONTAINER
           ======================================== */
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            transition: max-width 0.3s ease;
        }

        /* ========================================
           ANIMATIONS
           ======================================== */
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-in {
            animation: fadeInUp 0.5s ease forwards;
            opacity: 0;
        }

        .animate-delay-1 { animation-delay: 0.1s; }
        .animate-delay-2 { animation-delay: 0.2s; }
        .animate-delay-3 { animation-delay: 0.3s; }
        .animate-delay-4 { animation-delay: 0.4s; }

        /* ========================================
           HERO METRICS
           ======================================== */
        
        .hero-section {
            margin-bottom: 1.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            transition: all var(--transition-speed);
            position: relative;
        }

        [data-theme="tactical"] .metric-card {
            box-shadow: var(--shadow-card);
        }

        [data-theme="artistic"] .metric-card {
            box-shadow: var(--shadow-card);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
            border-color: var(--accent-primary);
        }

        [data-theme="tactical"] .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), transparent);
        }

        [data-theme="artistic"] .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-primary);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .metric-label {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: var(--font-mono);
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-family: var(--font-mono);
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        [data-theme="artistic"] .metric-value {
            font-family: var(--font-display);
        }

        .metric-value.highlight {
            color: var(--accent-primary);
        }

        .metric-subtext {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .metric-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            margin-top: 0.5rem;
        }

        .metric-change.positive {
            background: rgba(69, 212, 138, 0.15);
            color: var(--accent-secondary);
        }

        [data-theme="artistic"] .metric-change.positive {
            background: rgba(0, 150, 199, 0.15);
            color: var(--accent-secondary);
        }

        /* ========================================
           CHART CONTAINER
           ======================================== */
        
        .chart-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-card);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title {
            display: flex;
            align-items: center;
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
        }

        [data-theme="tactical"] .chart-title {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.9rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .chart-type-btn {
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-transform: uppercase;
        }

        .chart-type-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .chart-type-btn:hover:not(.active) {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .chart-wrapper {
            position: relative;
            height: 360px;
        }

        .chart-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            z-index: 5;
        }

        .chart-loading.hidden {
            display: none;
        }

        .chart-loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            margin-right: 0.75rem;
            animation: chart-spin 0.8s linear infinite;
        }

        @keyframes chart-spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================
           TABS
           ======================================== */
        
        /* ========================================
           TAB NAVIGATION (top-level)
           ======================================== */

        .tabs-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            margin-bottom: 1.5rem;
        }

        .tabs-nav .tabs-header {
            display: flex;
            gap: 0.5rem;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: auto;
            overflow-y: hidden;
            border-bottom: none;
            margin-bottom: 0;
        }

        .tabs-container {
            margin-bottom: 1.5rem;
        }

        .tabs-header {
            display: flex;
            gap: 0.25rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: var(--font-body);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed);
            white-space: nowrap;
        }

        [data-theme="tactical"] .tab-btn {
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.9rem;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--accent-primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-primary);
        }

        [data-theme="artistic"] .tab-btn.active::after {
            height: 3px;
            border-radius: 3px 3px 0 0;
        }

        .tab-shortcut {
            font-size: 0.6rem;
            opacity: 0.5;
            margin-left: 0.5rem;
            padding: 0.1rem 0.3rem;
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* ========================================
           STORY TAB
           ======================================== */
        
        .story-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }

        .story-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        [data-theme="tactical"] .story-header {
            background: linear-gradient(135deg, rgba(212, 168, 69, 0.1), transparent);
        }

        [data-theme="artistic"] .story-header {
            background: linear-gradient(135deg, rgba(232, 93, 4, 0.05), rgba(0, 150, 199, 0.05));
        }

        .story-header h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        [data-theme="tactical"] .story-header h2 {
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 1.1rem;
        }

        .story-header .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        [data-theme="tactical"] .story-header .subtitle {
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.75rem;
        }

        .story-content {
            padding: 2rem;
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }

        .story-text {
            font-size: 1rem;
            line-height: 1.9;
            color: var(--text-secondary);
            max-width: 800px;
            flex: 1;
            min-width: 0;
        }

        [data-theme="tactical"] .story-text {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.8;
        }

        [data-theme="artistic"] .story-text {
            font-family: var(--font-display);
            font-style: normal;
            font-size: 1.05rem;
        }

        .story-text p {
            margin-bottom: 1.5rem;
        }

        .story-text p:last-child {
            margin-bottom: 0;
        }

        .story-highlight {
            color: var(--accent-primary);
            font-weight: 600;
        }

        [data-theme="artistic"] .story-highlight {
            font-style: normal;
        }

        .story-stat {
            display: inline-block;
            background: var(--bg-tertiary);
            padding: 0.15rem 0.5rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.85em;
            font-style: normal;
        }

        /* Milestones */
        .milestones-section {
            width: 280px;
            flex-shrink: 0;
            padding: 1.25rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .milestones-title {
            font-family: var(--font-display);
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        [data-theme="tactical"] .milestones-title {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.8rem;
        }

        .milestone-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .milestone-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.875rem 1rem;
            position: relative;
            overflow: hidden;
        }

        .milestone-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--accent-secondary);
        }

        .milestone-icon {
            font-size: 1.25rem;
            margin-bottom: 0.35rem;
        }

        .milestone-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        [data-theme="tactical"] .milestone-title {
            font-family: var(--font-mono);
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .milestone-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .milestone-date {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Market Comparison Section */
        .market-section {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .market-section:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        /* Market Tab Container */
        .market-tab-container {
            padding: 1.5rem;
        }

        .market-header {
            margin-bottom: 1.5rem;
        }

        .market-header h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        [data-theme="tactical"] .market-header h2 {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 1.2rem;
        }

        .market-header .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Market Summary Card */
        .market-summary-cards {
            margin-bottom: 1.5rem;
        }

        .market-summary-card {
            display: flex;
            align-items: flex-start;
            gap: 1.25rem;
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--accent-primary);
        }

        .market-summary-card.outperforming {
            border-left-color: var(--accent-secondary);
        }

        .market-summary-card.underperforming {
            border-left-color: var(--accent-warning);
        }

        .market-summary-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .market-summary-content {
            flex: 1;
        }

        .market-summary-headline {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        [data-theme="tactical"] .market-summary-headline {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.95rem;
        }

        .market-summary-detail {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .market-summary-detail strong {
            color: var(--text-primary);
        }

        /* Inflation Analysis Section */
        .inflation-analysis {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 700px) {
            .inflation-analysis {
                grid-template-columns: 1fr;
            }
        }

        .inflation-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
        }

        .inflation-card-title {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .inflation-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: var(--font-mono);
            margin-bottom: 0.25rem;
        }

        .inflation-card-value.positive {
            color: var(--accent-secondary);
        }

        .inflation-card-value.negative {
            color: var(--accent-warning);
        }

        .inflation-card-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .inflation-breakdown {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border-color);
        }

        .inflation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            padding: 0.35rem 0;
        }

        .inflation-row-label {
            color: var(--text-secondary);
        }

        .inflation-row-value {
            font-family: var(--font-mono);
            font-weight: 600;
        }

        .inflation-row-value.positive {
            color: var(--accent-secondary);
        }

        .inflation-row-value.negative {
            color: var(--accent-warning);
        }

        .market-title {
            font-family: var(--font-display);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }

        [data-theme="tactical"] .market-title {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.8rem;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .market-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .market-grid {
                grid-template-columns: 1fr;
            }
        }

        .market-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            position: relative;
        }

        .market-card.positive {
            border-color: var(--accent-secondary);
        }

        .market-card.negative {
            border-color: var(--accent-warning);
        }

        .market-card.neutral {
            border-color: var(--border-color);
        }

        .market-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .market-card-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: var(--font-mono);
        }

        .market-card-badge {
            font-size: 0.6rem;
            padding: 0.2rem 0.4rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-weight: 600;
            text-transform: uppercase;
        }

        .market-card-badge.above {
            background: rgba(69, 212, 138, 0.2);
            color: var(--accent-secondary);
        }

        .market-card-badge.below {
            background: rgba(212, 87, 69, 0.2);
            color: var(--accent-warning);
        }

        .market-card-badge.at {
            background: rgba(212, 168, 69, 0.2);
            color: var(--accent-primary);
        }

        .market-card-value {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: var(--font-mono);
            margin-bottom: 0.25rem;
        }

        .market-card-value.positive {
            color: var(--accent-secondary);
        }

        .market-card-value.negative {
            color: var(--accent-warning);
        }

        .market-card-comparison {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .market-card-comparison strong {
            color: var(--text-primary);
        }

        .market-footnote {
            margin-top: 1.25rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border-color);
            font-size: 0.7rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Story stat indicators */
        .story-stat.positive {
            color: var(--accent-secondary);
            background: rgba(69, 212, 138, 0.15);
        }

        .story-stat.negative {
            color: var(--accent-warning);
            background: rgba(212, 87, 69, 0.15);
        }

        [data-theme="artistic"] .story-stat.positive {
            color: var(--accent-secondary);
            background: rgba(0, 150, 199, 0.15);
        }

        /* ========================================
           DATA TABLE
           ======================================== */
        
        .data-table-container {
            overflow-x: auto;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table th {
            background: var(--bg-tertiary);
            padding: 1rem;
            text-align: left;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
        }

        .data-table th .info-tooltip {
            margin-left: 4px;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-family: var(--font-mono);
            color: var(--text-primary);
        }

        [data-theme="artistic"] .data-table td {
            font-family: var(--font-body);
        }

        .data-table tr:hover td {
            background: var(--bg-hover);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-family: var(--font-mono);
            text-transform: uppercase;
        }

        .badge-merit {
            background: rgba(69, 212, 138, 0.15);
            color: var(--accent-secondary);
        }

        .badge-equity {
            background: rgba(69, 152, 212, 0.15);
            color: var(--accent-tertiary);
        }

        .badge-market {
            background: rgba(212, 168, 69, 0.15);
            color: var(--accent-primary);
        }

        .badge-new {
            background: rgba(212, 87, 69, 0.15);
            color: var(--accent-warning);
        }

        /* ========================================
           ANALYTICS SECTION
           ======================================== */
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 900px) {
            .analytics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        .analytics-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            box-shadow: var(--shadow-card);
        }

        .analytics-card-title {
            display: flex;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: var(--font-mono);
            margin-bottom: 0.75rem;
        }

        .analytics-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }

        [data-theme="artistic"] .analytics-card-value {
            font-family: var(--font-display);
        }

        .analytics-card-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* ========================================
           PROJECTIONS SECTION
           ======================================== */
        
        .projections-controls {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-card);
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: var(--font-mono);
            margin-bottom: 0.75rem;
        }

        .interval-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .interval-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .interval-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .interval-btn:hover:not(.active) {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .slider-container {
            margin-top: 1rem;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .slider-value {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--accent-primary);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: var(--glow-primary);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: none;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .input-field {
            flex: 1;
            min-width: 150px;
        }

        .input-field label {
            display: flex;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: var(--font-mono);
            margin-bottom: 0.5rem;
        }

        .input-field input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .input-field input:focus {
            border-color: var(--accent-primary);
        }

        .input-field input:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 0;
        }

        .projection-result {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 1rem;
        }

        .projection-result-title {
            display: flex;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: var(--font-mono);
        }

        .projection-result-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-secondary);
            font-family: var(--font-mono);
            margin-top: 0.25rem;
        }

        .projection-result-detail {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }

        .projections-intro {
            margin-bottom: 1.5rem;
        }

        .projections-intro h2 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .projections-intro p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .projections-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .projections-controls-row .control-group {
            flex: 1;
            min-width: 200px;
        }

        .target-group {
            min-width: 280px !important;
        }

        .target-inline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .target-inline span {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .target-inline input {
            width: 120px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .target-inline strong {
            color: var(--accent-secondary);
            font-family: var(--font-mono);
            font-size: 1rem;
        }

        .interval-buttons.centered {
            justify-content: center;
        }

        .scenario-label {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .scenario-label.conservative {
            background: rgba(0, 150, 199, 0.15);
            color: var(--accent-secondary);
        }

        .scenario-label.historical {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .scenario-label.aggressive {
            background: rgba(232, 93, 4, 0.15);
            color: var(--accent-primary);
        }

        .slider-context {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
        }

        .slider-context span {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .goal-input {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }

        .goal-currency {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-right: 0.25rem;
        }

        .goal-input input {
            width: 140px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 1rem;
        }

        .goal-answer {
            margin-top: 0.75rem;
        }

        .goal-answer span:first-child {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-secondary);
            font-family: var(--font-mono);
        }

        .goal-context {
            display: block;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }

        .projections-controls-row.two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .projections-controls-row.two-col .control-group {
            min-width: unset;
        }

        .chart-header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .chart-header-controls .interval-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .chart-header-controls .interval-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        .projection-slider-inline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .projection-slider-inline .slider-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .projection-slider-inline input[type="range"] {
            width: 100px;
        }

        .projection-slider-inline .slider-value {
            font-weight: 700;
            color: var(--accent-primary);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            min-width: 35px;
        }

        .projection-slider-inline .scenario-label {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
        }

        .projection-slider-inline .scenario-label.conservative {
            background: rgba(0, 150, 199, 0.15);
            color: var(--accent-secondary);
        }

        .projection-slider-inline .scenario-label.historical {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .projection-slider-inline .scenario-label.aggressive {
            background: rgba(232, 93, 4, 0.15);
            color: var(--accent-primary);
        }

        .projection-slider-inline .slider-context {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .projections-table {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-card);
        }

        /* ========================================
           HELP SECTION
           ======================================== */
        
        .help-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .help-grid {
                grid-template-columns: 1fr;
            }
        }

        .help-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
        }

        .help-card h3 {
            font-family: var(--font-display);
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        [data-theme="tactical"] .help-card h3 {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.85rem;
        }

        .help-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .help-card code {
            background: var(--bg-tertiary);
            padding: 0.15rem 0.4rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--accent-primary);
        }

        /* ========================================
           FOOTER
           ======================================== */
        
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-family: var(--font-mono);
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
        }

        /* ========================================
           UTILITY: HIDDEN
           ======================================== */

        .hidden {
            display: none !important;
        }

        /* ========================================
           ACCESSIBILITY: FOCUS STYLES
           ======================================== */

        .btn:focus-visible,
        .tab-btn:focus-visible,
        .theme-btn:focus-visible,
        .view-btn:focus-visible,
        .landing-theme-btn:focus-visible,
        .chart-type-btn:focus-visible,
        .demo-banner-close:focus-visible,
        .demo-regenerate-btn:focus-visible,
        .btn-demo:focus-visible,
        .btn-text:focus-visible,
        .btn-text-alt:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        textarea:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 0;
        }

        /* Skip link for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            padding: 0.5rem 1rem;
            background: var(--accent-primary);
            color: var(--bg-primary);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            z-index: 10000;
            transition: top 0.2s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* ========================================
           ACCESSIBILITY: REDUCED MOTION
           ======================================== */

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }

            .animate-in {
                animation: none;
                opacity: 1;
            }
        }

        /* ========================================
           PRIVACY CALLOUT (Right Panel)
           ======================================== */
        
        .privacy-callout {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 0.875rem;
            background: rgba(69, 212, 138, 0.1);
            border: 1px solid var(--accent-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 0.875rem;
            flex-shrink: 0;
        }

        [data-theme="artistic"] .privacy-callout {
            background: rgba(0, 150, 199, 0.1);
        }

        .privacy-callout-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .privacy-callout-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .privacy-callout-text strong {
            color: var(--accent-secondary);
        }

        /* ========================================
           DOWNLOAD OFFLINE BUTTON
           ======================================== */
        
        .privacy-download {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border-color);
        }

        .btn-download-offline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .btn-download-offline:hover {
            border-color: var(--accent-secondary);
            color: var(--accent-secondary);
            background: rgba(69, 212, 138, 0.1);
        }

        [data-theme="artistic"] .btn-download-offline:hover {
            background: rgba(0, 150, 199, 0.1);
        }

        .download-hint {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 0.4rem;
            font-style: italic;
        }

        /* ========================================
           BENCHMARK SOURCES
           ======================================== */
        
        .benchmark-sources {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .benchmark-sources-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .benchmark-sources-list {
            display: grid;
            gap: 0.5rem;
        }

        .benchmark-source-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .benchmark-source-item .source-icon {
            flex-shrink: 0;
            opacity: 0.6;
        }

        .benchmark-source-item .source-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .benchmark-disclaimer {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .source-link {
            color: var(--accent-secondary);
            text-decoration: none;
            border-bottom: 1px dotted var(--accent-secondary);
            transition: all var(--transition-speed);
        }

        .source-link:hover {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        /* ========================================
           TAB LINK (in-content navigation)
           ======================================== */
        
        .tab-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 600;
            font-style: normal;
            border-bottom: 2px solid var(--accent-primary);
            transition: all var(--transition-speed);
            cursor: pointer;
        }

        .tab-link:hover {
            color: var(--accent-secondary);
            border-bottom-color: var(--accent-secondary);
        }

        /* ========================================
           STORY INSIGHT
           ======================================== */
        
        .story-insight {
            margin-top: 2rem;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-secondary);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .story-insight-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: block;
            margin-bottom: 0.5rem;
        }

        [data-theme="tactical"] .story-insight {
            border-left-color: var(--accent-primary);
        }

        /* ========================================
           RESPONSIVE
           ======================================== */
        
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .main-container {
                padding: 1rem;
            }

            .chart-wrapper {
                height: 280px;
            }

            .keyboard-hint {
                display: none;
            }

            .privacy-badge {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .privacy-features {
                justify-content: center;
            }

            .landing-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Skip link for keyboard navigation -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- ==========================================
         MOBILE SPLASH SCREEN
         ========================================== -->
    <div id="mobileSplash" class="mobile-splash">
        <div class="mobile-splash-icon"></div>
        <h1 class="mobile-splash-title">Desktop Required</h1>
        <p class="mobile-splash-message">Compensation Journey is built for desktop browsers with larger screens. Please visit this page on a laptop or desktop computer to continue.</p>
    </div>

    <!-- ==========================================
         LANDING PAGE
         ========================================== -->
    <div id="landingPage" class="landing-page">
        <!-- Theme toggle -->
        <div class="landing-theme-toggle">
            <button class="landing-theme-btn" data-theme="tactical" onclick="setTheme('tactical')" aria-label="Dark tactical theme" aria-pressed="false">Tactical</button>
            <button class="landing-theme-btn active" data-theme="artistic" onclick="setTheme('artistic')" aria-label="Light artistic theme" aria-pressed="true">Artistic</button>
        </div>

        <div class="landing-container">
            <!-- Left Panel: Logo, Instructions, Privacy -->
            <div class="landing-left">
                <div class="landing-logo">
                    <div class="landing-logo-icon">CJ</div>
                    <div class="landing-logo-text">
                        <h1>Compensation Journey</h1>
                        <span>Paylocity  Insights</span>
                    </div>
                </div>

                <p class="landing-description">
                    Transform your raw Paylocity pay history into a beautiful, interactive dashboard. Visualize your career growth, analyze raise patterns, and project future earnings.
                </p>

                <div class="features-list">
                    <div class="feature-item">
                        <span class="feature-icon"></span>
                        <span>Interactive salary timeline with multiple chart types</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon"></span>
                        <span>Analytics: CAGR, averages, raise frequency & more</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon"></span>
                        <span>Future projections with customizable growth rates</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon"></span>
                        <span>Auto-generated narrative of your career story</span>
                    </div>
                </div>

                <div class="privacy-badge">
                    <div class="privacy-icon"></div>
                    <div class="privacy-content">
                        <h3>100% Private & Local</h3>
                        <p class="privacy-description">Your salary data never leaves your browser. No servers, no uploads, no trackingworks completely offline.</p>
                        <div class="privacy-features">
                            <span class="privacy-feature"><span class="check"></span> Offline capable</span>
                            <span class="privacy-feature"><span class="check"></span> No AI processing</span>
                            <span class="privacy-feature"><span class="check"></span> No external requests</span>
                            <span class="privacy-feature"><span class="check"></span> No data storage</span>
                        </div>
                        <p class="privacy-session-warning"> Data exists only in your current session. Refreshing or closing the tab will clear everything. Use <strong>Save Data</strong> to keep a local copy.</p>
                        <div class="privacy-download">
                            <button class="btn-download-offline" onclick="downloadHtmlFile()">
                                <span></span> Download for Offline Use
                            </button>
                            <p class="download-hint">Run locally with zero network access</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Paste Area & Actions -->
            <div class="landing-right">
                <div class="landing-right-header">
                    <h2> Import Your Data</h2>
                </div>

                <div class="demo-cta">
                    <button class="btn btn-demo" onclick="loadDemoData()">
                        <span class="demo-icon"></span> View Demo Dashboard
                    </button>
                    <span class="demo-hint">See what you'll get before importing your data</span>
                </div>

                <div class="instructions-box">
                    <div class="instructions-title">How to get your data from Paylocity</div>
                    <ol class="instructions-list">
                        <li>Log in to <code>paylocity.com</code></li>
                        <li>On your dashboard, click the <code>Pay</code> card heading</li>
                        <li>Click the <code>Show Private Data</code> button</li>
                        <li>Navigate to the <code>Rates</code> tab</li>
                        <li>Select all content starting from <code>Rates</code> at the top, through the History table, down to <code>items</code> at the bottom</li>
                        <li>Copy (Ctrl+C / Cmd+C) and paste below</li>
                    </ol>
                </div>

                <div class="privacy-callout">
                    <span class="privacy-callout-icon"></span>
                    <span class="privacy-callout-text"><strong>Your data stays on your device</strong>  nothing is sent anywhere. Disconnect from the internet to verify.</span>
                </div>

                <div class="paste-area">
                    <label for="pasteInput">Paste your Paylocity data here</label>
                    <textarea id="pasteInput" placeholder="Rates
Current
Effective Date  Change Reason  Pay Type  Per Check  Annual Salary
01/15/2025  Merit Increase  Salary  $4,583.33  $110,000.00

History
02/01/2024  Merit Increase  Salary  $4,250.00  $102,000.00
03/15/2023  Market Adjustment  Salary  $3,958.33  $95,000.00
..." oninput="validatePasteInput()"></textarea>
                    <div id="validationMessage" class="validation-message"></div>
                </div>

                <div class="landing-footer">
                    <button class="btn btn-primary" id="generateBtn" onclick="parseAndGenerate()" disabled>Generate Dashboard</button>
                    <button class="btn-text-alt" onclick="document.getElementById('jsonFileInput').click()">or load saved .json</button>
                    <input type="file" id="jsonFileInput" class="file-input" accept=".json" onchange="loadJsonFile(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- ==========================================
         DASHBOARD
         ========================================== -->
    <div id="dashboardPage" class="hidden">
        <!-- DEMO BANNER -->
        <div id="demoBanner" class="demo-banner hidden" role="alert">
            <span class="demo-banner-icon" aria-hidden="true"></span>
            <span class="demo-banner-text">
                <strong>Demo Mode:</strong>
                <span id="scenarioLabel">Scenario 1: Growth Phase (5 years)</span>
            </span>
            <button class="demo-regenerate-btn" onclick="cycleNextScenario()" aria-label="Try another demo scenario">
                 Try Another
            </button>
            <button class="demo-banner-close" onclick="document.getElementById('demoBanner').classList.add('hidden')" aria-label="Dismiss demo banner"></button>
        </div>

        <!-- HEADER -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">CJ</div>
                    <div class="logo-text">
                        <h1>Compensation Journey</h1>
                        <span>Personal Dashboard</span>
                    </div>
                </div>
                <div class="header-controls">
                    <div class="view-switcher" role="group" aria-label="Value display mode">
                        <button class="view-btn active" data-view="dollars" onclick="setViewMode('dollars')" aria-label="Show dollar values" aria-pressed="true">$</button>
                        <button class="view-btn" data-view="index" onclick="setViewMode('index')" aria-label="Show indexed values" aria-pressed="false">Index</button>
                    </div>
                    <div class="theme-switcher" role="group" aria-label="Theme selection">
                        <button class="theme-btn" data-theme="tactical" onclick="setTheme('tactical')" aria-label="Dark tactical theme" aria-pressed="false">Tactical</button>
                        <button class="theme-btn active" data-theme="artistic" onclick="setTheme('artistic')" aria-label="Light artistic theme" aria-pressed="true">Artistic</button>
                    </div>
                    <button class="btn btn-secondary" onclick="downloadData()" style="padding: 0.5rem 0.75rem; font-size: 0.65rem;">Save Data</button>
                    <button class="btn btn-secondary" onclick="resetDashboard()" style="padding: 0.5rem 0.75rem; font-size: 0.65rem;">Start Over</button>
                </div>
            </div>
        </header>

        <!-- KEYBOARD SHORTCUTS HINT -->
        <div class="keyboard-hint">
            <kbd>1</kbd>-<kbd>7</kbd> tabs  <kbd>T</kbd> theme  <kbd>V</kbd> view
        </div>

        <!-- TAB NAVIGATION -->
        <nav class="tabs-nav" aria-label="Dashboard sections">
            <div class="tabs-header" role="tablist">
                <button class="tab-btn active" id="tab-btn-home" data-tab="home" onclick="setTab('home')" role="tab" aria-selected="true" aria-controls="tab-home">Home<span class="tab-shortcut" aria-hidden="true">1</span></button>
                <button class="tab-btn" id="tab-btn-story" data-tab="story" onclick="setTab('story')" role="tab" aria-selected="false" aria-controls="tab-story">Story<span class="tab-shortcut" aria-hidden="true">2</span></button>
                <button class="tab-btn" id="tab-btn-market" data-tab="market" onclick="setTab('market')" role="tab" aria-selected="false" aria-controls="tab-market">Market<span class="tab-shortcut" aria-hidden="true">3</span></button>
                <button class="tab-btn" id="tab-btn-history" data-tab="history" onclick="setTab('history')" role="tab" aria-selected="false" aria-controls="tab-history">History<span class="tab-shortcut" aria-hidden="true">4</span></button>
                <button class="tab-btn" id="tab-btn-analytics" data-tab="analytics" onclick="setTab('analytics')" role="tab" aria-selected="false" aria-controls="tab-analytics">Analytics<span class="tab-shortcut" aria-hidden="true">5</span></button>
                <button class="tab-btn" id="tab-btn-projections" data-tab="projections" onclick="setTab('projections')" role="tab" aria-selected="false" aria-controls="tab-projections">Projections<span class="tab-shortcut" aria-hidden="true">6</span></button>
                <button class="tab-btn" id="tab-btn-help" data-tab="help" onclick="setTab('help')" role="tab" aria-selected="false" aria-controls="tab-help">Help<span class="tab-shortcut" aria-hidden="true">7</span></button>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-container" id="main-content">
            <!-- HOME TAB -->
            <div class="tab-content active" id="tab-home" role="tabpanel" aria-labelledby="tab-btn-home">
            <!-- HERO METRICS -->
            <section class="hero-section">
                <div class="metrics-grid">
                    <div class="metric-card animate-in animate-delay-1">
                        <div class="metric-label">
                            Current Compensation
                            <span class="info-tooltip"><span class="tip-text">Your most recent annual salary as of the last recorded adjustment. This reflects base salary only, excluding bonuses or equity.</span></span>
                        </div>
                        <div class="metric-value highlight" id="currentSalary">$281,600</div>
                        <div class="metric-subtext" id="currentSalaryIndexed">Index: 704</div>
                    </div>
                    <div class="metric-card animate-in animate-delay-2">
                        <div class="metric-label">
                            Total Growth
                            <span class="info-tooltip"><span class="tip-text">The percentage increase from your starting salary to your current salary. Calculated as: ((Current - Starting) / Starting)  100</span></span>
                        </div>
                        <div class="metric-value" id="totalGrowth">+604%</div>
                        <div class="metric-change positive"> Since hire</div>
                    </div>
                    <div class="metric-card animate-in animate-delay-3">
                        <div class="metric-label">
                            Years of Service
                            <span class="info-tooltip"><span class="tip-text">Total time elapsed since your hire date to the most recent compensation record.</span></span>
                        </div>
                        <div class="metric-value" id="yearsService">12.8</div>
                        <div class="metric-subtext" id="hireDateText">Since Mar 2012</div>
                    </div>
                    <div class="metric-card animate-in animate-delay-4">
                        <div class="metric-label">
                            Total Adjustments
                            <span class="info-tooltip"><span class="tip-text">The number of compensation changes on record, including merit increases, equity adjustments, market adjustments, and your initial hire rate.</span></span>
                        </div>
                        <div class="metric-value" id="totalRaises">19</div>
                        <div class="metric-subtext" id="avgRaisesPerYear">Avg: 1.5 per year</div>
                    </div>
                </div>
            </section>

            <!-- MAIN CHART -->
            <section class="chart-section animate-in" style="animation-delay: 0.5s;">
                <div class="chart-header">
                    <h2 class="chart-title">
                        Compensation Timeline
                        <span class="info-tooltip"><span class="tip-text">Visual representation of your salary progression over time. Each point represents a compensation adjustment. Hover over points for details.</span></span>
                    </h2>
                    <div class="chart-controls">
                        <button class="chart-type-btn active" data-chart="line" onclick="setChartType('line')">Line</button>
                        <button class="chart-type-btn" data-chart="area" onclick="setChartType('area')">Area</button>
                        <button class="chart-type-btn" data-chart="bar" onclick="setChartType('bar')">Bar</button>
                        <button class="chart-type-btn" data-chart="step" onclick="setChartType('step')">Step</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-loading" id="mainChartLoading">Loading chart...</div>
                    <canvas id="mainChart"></canvas>
                </div>
            </section>
            </div>

            <!-- TABS -->
            <section class="tabs-container">
                <!-- STORY TAB -->
                <div class="tab-content" id="tab-story" role="tabpanel" aria-labelledby="tab-btn-story">
                    <div class="story-container">
                        <div class="story-header">
                            <h2 id="storyTitle">Mission Debrief: Compensation Trajectory</h2>
                            <p class="subtitle" id="storySubtitle">Classification: Personnel Asset Valuation Report</p>
                        </div>
                        <div class="story-content">
                            <div class="story-text" id="storyText"></div>
                            
                            <div class="milestones-section">
                                <h3 class="milestones-title">
                                    Key Milestones Achieved
                                    <span class="info-tooltip"><span class="tip-text">Automatically detected career achievements based on your compensation history.</span></span>
                                </h3>
                                <div class="milestone-grid" id="milestonesGrid"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MARKET TAB -->
                <div class="tab-content" id="tab-market" role="tabpanel" aria-labelledby="tab-btn-market">
                    <div class="market-tab-container">
                        <div class="market-header">
                            <h2 id="marketTitle">Market Position Analysis</h2>
                            <p class="subtitle" id="marketSubtitle">How your compensation compares to B2B SaaS industry benchmarks</p>
                        </div>
                        
                        <div class="market-summary-cards">
                            <div class="market-summary-card" id="marketSummaryCard">
                                <div class="market-summary-icon"></div>
                                <div class="market-summary-content">
                                    <div class="market-summary-headline" id="marketSummaryHeadline">Loading...</div>
                                    <div class="market-summary-detail" id="marketSummaryDetail"></div>
                                </div>
                            </div>
                        </div>

                        <div class="market-section">
                            <h3 class="market-title">
                                Key Metrics vs Industry
                                <span class="info-tooltip"><span class="tip-text">Your compensation metrics compared to B2B SaaS industry benchmarks. Data compiled from Radford, Mercer, and industry surveys.</span></span>
                            </h3>
                            <div class="market-grid" id="marketComparisonGrid"></div>
                        </div>

                        <div class="market-section">
                            <h3 class="market-title">
                                Inflation & Purchasing Power
                                <span class="info-tooltip"><span class="tip-text">How inflation has impacted your real earnings over time. CPI data from Bureau of Labor Statistics.</span></span>
                            </h3>
                            <div class="inflation-analysis" id="inflationAnalysis"></div>
                        </div>

                        <div class="benchmark-sources">
                            <div class="benchmark-sources-header">
                                <span></span> Data Sources & Methodology
                            </div>
                            <div class="benchmark-sources-list">
                                <div class="benchmark-source-item">
                                    <span class="source-icon"></span>
                                    <span><span class="source-label">Salary Benchmarks:</span> Compiled from <a href="https://radford.aon.com/" target="_blank" rel="noopener" class="source-link">Radford Global Technology Survey</a>, <a href="https://www.mercer.com/solutions/total-rewards/compensation-benchmarking/" target="_blank" rel="noopener" class="source-link">Mercer Total Remuneration Survey</a>, <a href="https://www.levels.fyi/" target="_blank" rel="noopener" class="source-link">Levels.fyi</a>, and <a href="https://www.glassdoor.com/Salaries/" target="_blank" rel="noopener" class="source-link">Glassdoor</a> B2B SaaS compensation data (2024-2025)</span>
                                </div>
                                <div class="benchmark-source-item">
                                    <span class="source-icon"></span>
                                    <span><span class="source-label">Inflation Data:</span> <a href="https://www.bls.gov/cpi/" target="_blank" rel="noopener" class="source-link">U.S. Bureau of Labor Statistics</a> Consumer Price Index (CPI-U), Annual Averages</span>
                                </div>
                                <div class="benchmark-source-item">
                                    <span class="source-icon"></span>
                                    <span><span class="source-label">Industry CAGR:</span> Based on 6% average compensation growth in B2B SaaS sector, derived from industry surveys and public company filings</span>
                                </div>
                            </div>
                            <div class="benchmark-disclaimer">
                                Benchmarks represent industry averages and may vary significantly by role, experience level, location, and company stage. This tool is for informational purposes only.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HISTORY TAB -->
                <div class="tab-content" id="tab-history" role="tabpanel" aria-labelledby="tab-btn-history">
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Effective Date</th>
                                    <th>Reason</th>
                                    <th>Annual Salary</th>
                                    <th>Index</th>
                                    <th>Change</th>
                                    <th>% Change</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ANALYTICS TAB -->
                <div class="tab-content" id="tab-analytics" role="tabpanel" aria-labelledby="tab-btn-analytics">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-card-title">
                                Compound Annual Growth Rate
                                <span class="info-tooltip"><span class="tip-text">If your salary grew by the same percentage every year, this is what that percentage would be. It smooths out the ups and downs into one number.</span></span>
                            </div>
                            <div class="analytics-card-value" id="cagr">16.4%</div>
                            <div class="analytics-card-detail">Average annual growth over career</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-card-title">
                                Average Raise
                                <span class="info-tooltip"><span class="tip-text">The arithmetic mean of all your raise percentages.</span></span>
                            </div>
                            <div class="analytics-card-value" id="avgRaise">12.7%</div>
                            <div class="analytics-card-detail" id="avgRaiseDollar">~$12,700 per adjustment</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-card-title">
                                Median Raise
                                <span class="info-tooltip"><span class="tip-text">The middle value when all raises are sorted.</span></span>
                            </div>
                            <div class="analytics-card-value" id="medianRaise">11.2%</div>
                            <div class="analytics-card-detail">Middle value of all raises</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-card-title">
                                Largest Single Increase
                                <span class="info-tooltip"><span class="tip-text">Your biggest percentage raise in a single adjustment.</span></span>
                            </div>
                            <div class="analytics-card-value" id="largestRaise">29.5%</div>
                            <div class="analytics-card-detail" id="largestRaiseDate">April 2015</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-card-title">
                                Avg. Time Between Raises
                                <span class="info-tooltip"><span class="tip-text">How frequently you receive compensation adjustments. The industry standard is typically 12 months (annual review cycles).</span></span>
                            </div>
                            <div class="analytics-card-value" id="avgTimeBetween">8.1 mo</div>
                            <div class="analytics-card-detail" id="avgTimeDetail">Industry standard: 12 months</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-card-title">
                                Merit Increases
                                <span class="info-tooltip"><span class="tip-text">Number of raises specifically categorized as merit-based.</span></span>
                            </div>
                            <div class="analytics-card-value" id="meritCount">14</div>
                            <div class="analytics-card-detail" id="meritPercent">73.7% of all adjustments</div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-header">
                            <h2 class="chart-title">Annual Salary Change Rate</h2>
                            <div class="chart-controls">
                                <button class="chart-type-btn active" data-chart="yoy-bar" onclick="setYoyChartType('bar')">Bar</button>
                                <button class="chart-type-btn" data-chart="yoy-line" onclick="setYoyChartType('line')">Line</button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="yoyChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-header">
                            <h2 class="chart-title">Adjustments by Category</h2>
                        </div>
                        <div class="chart-wrapper" style="height: 250px;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- PROJECTIONS TAB -->
                <div class="tab-content" id="tab-projections" role="tabpanel" aria-labelledby="tab-btn-projections">
                    <div class="projections-intro">
                        <h2>Future Compensation Projections</h2>
                        <p>Explore potential salary growth scenarios. Adjust the raise percentage to see how different growth rates would impact your compensation over time.</p>
                    </div>

                    <div class="chart-section">
                        <div class="chart-header">
                            <h2 class="chart-title">Future Trajectory</h2>
                            <div class="chart-header-controls">
                                <div class="projection-slider-inline">
                                    <span class="slider-label">What if raises average</span>
                                    <input type="range" min="0" max="25" value="8" id="customRateSlider" oninput="updateCustomRate()">
                                    <span class="slider-value" id="customRateValue">8%</span>
                                    <span class="slider-context">(Your historical: <span id="historicalRateDisplay">--</span>)</span>
                                </div>
                                <div class="interval-buttons">
                                    <button class="interval-btn" data-years="1" onclick="setProjectionYears(1)">1 yr</button>
                                    <button class="interval-btn" data-years="3" onclick="setProjectionYears(3)">3 yr</button>
                                    <button class="interval-btn active" data-years="5" onclick="setProjectionYears(5)">5 yr</button>
                                    <button class="interval-btn" data-years="10" onclick="setProjectionYears(10)">10 yr</button>
                                    <button class="interval-btn" data-years="20" onclick="setProjectionYears(20)">20 yr</button>
                                </div>
                                <div class="chart-controls">
                                    <button class="chart-type-btn active" data-view="chart" onclick="setProjectionView('chart')">Chart</button>
                                    <button class="chart-type-btn" data-view="table" onclick="setProjectionView('table')">Table</button>
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="projectionChartWrapper">
                            <canvas id="projectionChart"></canvas>
                        </div>
                        <div class="projections-table hidden" id="projectionTableWrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Historical CAGR</th>
                                        <th>Conservative (5%)</th>
                                        <th>Custom Rate</th>
                                        <th>Optimistic (12%)</th>
                                    </tr>
                                </thead>
                                <tbody id="projectionTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- HELP TAB -->
                <div class="tab-content" id="tab-help" role="tabpanel" aria-labelledby="tab-btn-help">
                    <div class="help-grid">
                        <div class="help-card">
                            <h3>Understanding Indexed Values</h3>
                            <p>When privacy mode is enabled, salary values are shown as an index where your starting salary equals <code>100</code>. An index of <code>704</code> means your current compensation is 7.04 your starting salary.</p>
                        </div>
                        <div class="help-card">
                            <h3>CAGR (Compound Annual Growth Rate)</h3>
                            <p>CAGR represents the mean annual growth rate over a specified time period. Formula: <code>((Final/Initial)^(1/years)) - 1</code></p>
                        </div>
                        <div class="help-card">
                            <h3>Adjustment Categories</h3>
                            <p><strong>Merit Increase:</strong> Performance-based raise.<br>
                            <strong>Equity:</strong> Internal fairness alignment.<br>
                            <strong>Market Adjustment:</strong> External market response.<br>
                            <strong>New Hire:</strong> Starting compensation.</p>
                        </div>
                        <div class="help-card">
                            <h3>Saving Your Data</h3>
                            <p>Click <code>Save Data</code> to download a JSON file. Load it later with <code>Load Saved Data</code> on the landing pageno need to re-paste from Paylocity.</p>
                        </div>
                        <div class="help-card">
                            <h3>Privacy & Security</h3>
                            <p>All processing happens in your browser. No data is sent to any server. You can verify this by disconnecting from the internetthe dashboard will still work.</p>
                        </div>
                        <div class="help-card">
                            <h3>Keyboard Shortcuts</h3>
                            <p><code>1-7</code> Switch tabs<br>
                            <code>T</code> Toggle theme<br>
                            <code>V</code> Toggle view ($/Index)</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- FOOTER -->
        <footer class="footer">
            <p>Compensation Journey Dashboard  100% Local Processing  Your data never leaves your device</p>
        </footer>
    </div>

    <script>
        // ========================================
        // MOBILE/TABLET DETECTION
        // ========================================
        
        (function() {
            const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i.test(navigator.userAgent);
            const isSmallScreen = window.innerWidth < 900;
            
            if (isMobileUA || isSmallScreen) {
                document.getElementById('mobileSplash').classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // Also check on resize
            window.addEventListener('resize', function() {
                if (window.innerWidth < 900) {
                    document.getElementById('mobileSplash').classList.add('active');
                    document.body.style.overflow = 'hidden';
                } else if (!(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i.test(navigator.userAgent))) {
                    document.getElementById('mobileSplash').classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        })();

        // ========================================
        // DOWNLOAD FUNCTION
        // ========================================
        
        function downloadHtmlFile() {
            const html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'compensation-journey.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========================================
        // STATE
        // ========================================
        
        let employeeData = null;
        
        let state = {
            theme: 'artistic',
            showDollars: true,
            currentTab: 'home',
            mainChartType: 'line',
            yoyChartType: 'bar',
            projectionYears: 5,
            customRate: 8,
            currentScenarioIndex: 0
        };

        let charts = {
            main: null,
            yoy: null,
            category: null,
            projection: null
        };

        // ========================================
        // BENCHMARK DATA (B2B SaaS Industry)
        // ========================================
        
        const benchmarks = {
            // Annual raise percentages
            typicalRaise: { min: 3, max: 5, avg: 4 },
            highPerformerRaise: { min: 6, max: 10, avg: 8 },
            promotionBump: { min: 10, max: 20, avg: 15 },
            
            // Growth metrics
            industryCagr: 6, // ~6% average CAGR for tech compensation
            
            // Timing
            avgMonthsBetweenRaises: 12,
            
            // Sources: Compiled from Radford, Mercer, Levels.fyi, Glassdoor B2B SaaS data
            lastUpdated: '2025'
        };

        // US CPI-U Annual Inflation Rates (%)
        // Source: Bureau of Labor Statistics
        const cpiData = {
            2010: 1.6, 2011: 3.2, 2012: 2.1, 2013: 1.5, 2014: 1.6,
            2015: 0.1, 2016: 1.3, 2017: 2.1, 2018: 2.4, 2019: 1.8,
            2020: 1.2, 2021: 4.7, 2022: 8.0, 2023: 4.1, 2024: 2.9,
            2025: 2.5 // Projected
        };

        // ========================================
        // BENCHMARK CALCULATION FUNCTIONS
        // ========================================
        
        function calculateInflationOverPeriod(startYear, endYear, startMonth = 0, endMonth = 11) {
            // Supports partial years - months are 0-indexed (0 = January, 11 = December)
            let cumulativeInflation = 1;
            
            for (let year = startYear; year <= endYear; year++) {
                const rate = cpiData[year] || 2.5; // Default to 2.5% if year not found
                
                if (year === startYear && year === endYear) {
                    // Same year - calculate partial
                    const monthsInPeriod = endMonth - startMonth + 1;
                    const partialRate = (rate / 12) * monthsInPeriod;
                    cumulativeInflation *= (1 + partialRate / 100);
                } else if (year === startYear) {
                    // First year - partial from startMonth to December
                    const monthsRemaining = 12 - startMonth;
                    const partialRate = (rate / 12) * monthsRemaining;
                    cumulativeInflation *= (1 + partialRate / 100);
                } else if (year === endYear) {
                    // Last year - partial from January to endMonth
                    const monthsElapsed = endMonth + 1;
                    const partialRate = (rate / 12) * monthsElapsed;
                    cumulativeInflation *= (1 + partialRate / 100);
                } else {
                    // Full year
                    cumulativeInflation *= (1 + rate / 100);
                }
            }
            return (cumulativeInflation - 1) * 100; // Return as percentage
        }

        /**
         * Calculates inflation-adjusted (real) growth rate.
         *
         * Uses the formula: Real Growth = ((1 + Nominal) / (1 + Inflation)) - 1
         *
         * This shows how much purchasing power actually increased after accounting
         * for inflation. A 5% nominal raise with 3% inflation = 1.94% real growth.
         *
         * @param {number} nominalGrowthPercent - Nominal growth rate as percentage (e.g., 5 for 5%)
         * @param {number} inflationPercent - Inflation rate as percentage (e.g., 3 for 3%)
         * @returns {number} Real growth rate as percentage
         *
         * @example
         * const realGrowth = calculateRealGrowth(5, 3);
         * console.log(realGrowth); // 1.94 (approximately)
         */
        function calculateRealGrowth(nominalGrowthPercent, inflationPercent) {
            // Real growth = ((1 + nominal) / (1 + inflation)) - 1
            const nominal = nominalGrowthPercent / 100;
            const inflation = inflationPercent / 100;
            return ((1 + nominal) / (1 + inflation) - 1) * 100;
        }

        function calculateInflationAdjustedSalary(salary, fromYear, toYear) {
            let adjustedSalary = salary;
            for (let year = fromYear; year < toYear; year++) {
                const rate = cpiData[year] || 2.5;
                adjustedSalary *= (1 + rate / 100);
            }
            return adjustedSalary;
        }

        function getBenchmarkComparisons() {
            if (!employeeData) return null;
            
            const raises = employeeData.records.filter(r => r.changePercent > 0);
            const avgRaise = raises.length > 0 
                ? raises.reduce((sum, r) => sum + r.changePercent, 0) / raises.length 
                : 0;
            
            const userCagr = calculateCAGR();
            const years = calculateYearsOfService();
            const hireDate = new Date(employeeData.hireDate);
            const currentDate = new Date(employeeData.currentDate);
            const startYear = hireDate.getFullYear();
            const startMonth = hireDate.getMonth();
            const endYear = currentDate.getFullYear();
            const endMonth = currentDate.getMonth();
            
            // Calculate time between raises (exclude "New Hire" - it's the starting point)
            const adjustments = employeeData.records.filter(r => r.reason !== 'New Hire');
            const dates = adjustments.map(r => new Date(r.date)).sort((a, b) => a - b);
            let totalDays = 0;
            for (let i = 1; i < dates.length; i++) {
                totalDays += (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
            }
            const avgMonthsBetween = dates.length > 1 ? (totalDays / (dates.length - 1)) / 30.44 : 12;
            
            // Inflation calculations (with partial year support)
            const totalInflation = calculateInflationOverPeriod(startYear, endYear, startMonth, endMonth);
            const startSalary = getStartingSalary();
            const currentSalary = getCurrentSalary();
            const nominalGrowth = ((currentSalary - startSalary) / startSalary) * 100;
            const realGrowth = calculateRealGrowth(nominalGrowth, totalInflation);
            
            // What starting salary would be worth today (inflation-adjusted)
            const inflationAdjustedStart = calculateInflationAdjustedSalary(startSalary, startYear, endYear);
            const purchasingPowerGain = currentSalary - inflationAdjustedStart;
            
            // Industry comparison: what would salary be at industry CAGR?
            const industryProjectedSalary = startSalary * Math.pow(1 + benchmarks.industryCagr / 100, years);
            
            return {
                // User metrics
                avgRaise,
                userCagr,
                avgMonthsBetween,
                totalRaises: raises.length,
                
                // Growth comparisons
                nominalGrowth,
                totalInflation,
                realGrowth,
                inflationAdjustedStart,
                purchasingPowerGain,
                
                // Industry comparisons
                industryProjectedSalary,
                vsIndustrySalary: currentSalary - industryProjectedSalary,
                vsIndustryPercent: ((currentSalary / industryProjectedSalary) - 1) * 100,
                
                // Raise comparisons
                raiseVsTypical: avgRaise - benchmarks.typicalRaise.avg,
                raiseVsHighPerformer: avgRaise - benchmarks.highPerformerRaise.avg,
                cagrVsIndustry: userCagr - benchmarks.industryCagr,
                
                // Timing comparisons
                raisesMoreFrequent: benchmarks.avgMonthsBetweenRaises - avgMonthsBetween,
                
                // Performance tier
                performanceTier: avgRaise >= benchmarks.highPerformerRaise.min ? 'high' :
                                 avgRaise >= benchmarks.typicalRaise.avg ? 'solid' : 'below'
            };
        }

        // ========================================
        // SECURITY HELPERS
        // ========================================

        /**
         * Escapes HTML special characters to prevent XSS attacks.
         * Converts characters that have special meaning in HTML to their entity equivalents.
         *
         * **Security Context:**
         * This function protects against XSS (Cross-Site Scripting) attacks by escaping
         * user-provided data before inserting it into HTML via innerHTML. Even though the
         * parser uses a whitelist approach for the 'reason' field, this provides defense
         * in depth at the display layer.
         *
         * **When to Use:**
         * - Always escape user-provided strings before inserting via innerHTML
         * - Especially important for the 'reason' field from Paylocity data
         * - Use for any data that could potentially contain malicious input
         *
         * **Where Used:**
         * - buildHistoryTable() - Escapes r.reason before display
         * - buildMilestones() - Escapes milestone text fields
         *
         * @param {string} str - The string to escape
         * @returns {string} The escaped string safe for insertion into HTML
         *
         * @example
         * escapeHTML('<script>alert("XSS")</script>')
         * // Returns: '&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;'
         *
         * @example
         * // Safe usage in template literal
         * element.innerHTML = `<span>${escapeHTML(userInput)}</span>`;
         */
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;

            const htmlEscapeMap = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#x27;',
                '/': '&#x2F;'
            };

            return str.replace(/[&<>"'\/]/g, char => htmlEscapeMap[char]);
        }

        // ========================================
        // PARSER
        // ========================================

        /**
         * Validates salary values are within reasonable ranges.
         * Prevents parsing of corrupted/malicious data with extreme values.
         *
         * **Security Context:**
         * Protects against:
         * - Chart rendering failures from extreme values
         * - Memory overflow in calculations
         * - Misleading visualizations from unrealistic salaries
         *
         * @param {number} value - Salary value to validate
         * @param {string} fieldName - Field name for error messages ('annual', 'perCheck', 'hourlyRate')
         * @returns {number} The validated value
         * @throws {Error} If value is outside valid range or not finite
         *
         * @example
         * validateSalaryRange(65000, 'annual') //  65000 (valid)
         * validateSalaryRange(999999999, 'annual') //  Throws error (too high)
         * validateSalaryRange(-5000, 'annual') //  Throws error (negative)
         */
        function validateSalaryRange(value, fieldName = 'salary') {
            // Reasonable ranges for US compensation data
            const ranges = {
                annual: { min: 1000, max: 10000000 },      // $1K - $10M (executive cap)
                perCheck: { min: 50, max: 400000 },         // $50 - $400K per paycheck
                hourlyRate: { min: 1, max: 5000 },          // $1 - $5K per hour
                change: { min: 0, max: 5000000 }            // $0 - $5M raise (one-time)
            };

            const range = ranges[fieldName] || ranges.annual;

            // Check for invalid numbers (NaN, Infinity, etc.)
            if (!Number.isFinite(value)) {
                throw new Error(`Invalid ${fieldName}: ${value} (not a finite number)`);
            }

            // Check range
            if (value < range.min || value > range.max) {
                const formatted = value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                const minFormatted = range.min.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                const maxFormatted = range.max.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                throw new Error(`${fieldName} ${formatted} outside valid range (${minFormatted} - ${maxFormatted})`);
            }

            return value;
        }

        /**
         * Parses raw Paylocity compensation history data into structured records.
         *
         * Handles inconsistent formatting from Paylocity's "Rates" tab by using multiple
         * fallback strategies to extract dates, dollar amounts, and hourly rates. Robust
         * against concatenated values (e.g., "$1,166.6712.2807") and missing fields.
         *
         * @param {string} rawText - Raw text copied from Paylocity "Rates" tab
         * @returns {Object} Parsed compensation data
         * @returns {string} returns.hireDate - Earliest record date (YYYY-MM-DD format)
         * @returns {string} returns.currentDate - Most recent record date (YYYY-MM-DD format)
         * @returns {Array<Object>} returns.records - Array of compensation records, sorted descending by date
         * @returns {string} returns.records[].date - Record date (YYYY-MM-DD)
         * @returns {string} returns.records[].reason - Change reason ('Merit Increase', 'Promotion', etc.)
         * @returns {number} returns.records[].perCheck - Per-paycheck amount (bi-weekly)
         * @returns {number} returns.records[].annual - Annual salary
         * @returns {number} returns.records[].hourlyRate - Hourly rate (may be null)
         * @returns {number} returns.records[].change - Dollar change from previous record
         * @returns {number} returns.records[].changePercent - Percentage change from previous record
         * @throws {Error} If no valid dates found or no records could be parsed
         *
         * @example
         * const data = parsePaylocityData("01/15/2023   Merit Increase   $2,500.0065,000.0031.25");
         * console.log(data.records[0].annual); // 65000
         */
        function parsePaylocityData(rawText) {
            const records = [];
            
            // Clean up the text
            let text = rawText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // Find all date patterns (MM/DD/YYYY) which start each record
            // Pattern: \d{2}\/\d{2}\/\d{4} matches MM/DD/YYYY (e.g., "01/15/2023")
            // Captured group (\d{2}\/\d{2}\/\d{4}) extracts the full date
            // Global flag 'g' finds all occurrences (one per compensation record)
            const datePattern = /(\d{2}\/\d{2}\/\d{4})/g;
            const dates = [];
            let match;
            
            while ((match = datePattern.exec(text)) !== null) {
                dates.push({ date: match[1], index: match.index });
            }
            
            if (dates.length === 0) {
                throw new Error('No valid dates found in the data');
            }
            
            // Extract each record between dates
            for (let i = 0; i < dates.length; i++) {
                const startIdx = dates[i].index;
                const endIdx = i < dates.length - 1 ? dates[i + 1].index : text.length;
                const recordText = text.substring(startIdx, endIdx);
                
                try {
                    const record = parseRecord(dates[i].date, recordText);
                    if (record) {
                        records.push(record);
                    }
                } catch (e) {
                    console.warn('Failed to parse record:', recordText, e);
                }
            }
            
            if (records.length === 0) {
                throw new Error('Could not parse any records from the data');
            }
            
            // Sort by date descending (most recent first)
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Find hire date (earliest record)
            const sortedByDate = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
            const hireDate = sortedByDate[0].date;
            const currentDate = sortedByDate[sortedByDate.length - 1].date;
            
            return {
                hireDate,
                currentDate,
                records
            };
        }
        
        function parseRecord(dateStr, text) {
            // Convert date format from MM/DD/YYYY to YYYY-MM-DD
            const [month, day, year] = dateStr.split('/');
            const date = `${year}-${month}-${day}`;
            
            // Extract change reason (whitelist approach for security)
            let reason = 'Unknown';
            const reasons = ['Merit Increase', 'Promotion', 'Market Adjustment', 'Equity', 'New Hire'];
            for (const r of reasons) {
                if (text.includes(r)) {
                    reason = r;
                    break;
                }
            }
            if (text.includes('') && reason === 'Unknown') {
                reason = '';
            }

            // Security: Strip any HTML-like patterns from reason (defense in depth)
            // This protects against malicious input even though we escape at display time
            reason = reason.replace(/<[^>]*>/g, '');
            
            // Extract dollar amounts - use exactly 2 decimal places to handle concatenated values
            // e.g., "$1,166.6712.2807" should parse as $1,166.67 (not $1,166.6712)
            // Pattern breakdown:
            //   \$ - Literal dollar sign
            //   ([0-9,]+\.\d{2}) - Captured group:
            //     [0-9,]+ - One or more digits or commas (e.g., "1,166" or "65000")
            //     \. - Literal decimal point
            //     \d{2} - Exactly 2 decimal digits (prevents capturing extra decimals from concatenated values)
            // Why exactly 2 decimals? Paylocity concatenates values like "$1,166.6712.2807"
            // Using \d{2} stops at "$1,166.67" instead of greedily taking "$1,166.6712"
            const dollarPattern = /\$([0-9,]+\.\d{2})/g;
            const dollars = [];
            let dollarMatch;
            while ((dollarMatch = dollarPattern.exec(text)) !== null) {
                dollars.push(parseFloat(dollarMatch[1].replace(/,/g, '')));
            }
            
            // Expected order: Per Check, Annual Salary, Amount (change)
            let perCheck = 0, annual = 0, change = 0;

            if (dollars.length >= 2) {
                // Find the annual salary (typically the largest reasonable number, >= 20000)
                const annualCandidates = dollars.filter(d => d >= 20000);
                if (annualCandidates.length > 0) {
                    annual = validateSalaryRange(annualCandidates[0], 'annual');
                }

                // Per check is usually the first dollar amount
                perCheck = dollars[0];
                if (perCheck >= 20000) {
                    // First one was annual, find actual per check
                    const perCheckCandidate = dollars.find(d => d < 20000 && d > 100) || 0;
                    perCheck = perCheckCandidate > 0 ? validateSalaryRange(perCheckCandidate, 'perCheck') : 0;
                } else {
                    perCheck = perCheck > 0 ? validateSalaryRange(perCheck, 'perCheck') : 0;
                }

                // Change/Amount is usually after annual salary
                if (dollars.length >= 3) {
                    const annualIdx = dollars.indexOf(annualCandidates[0]); // Use unvalidated value for indexOf
                    const afterAnnual = dollars.slice(annualIdx + 1);
                    if (afterAnnual.length > 0 && afterAnnual[0] > 0) {
                        change = validateSalaryRange(afterAnnual[0], 'change');
                    }
                }
            }
            
            // Extract hourly rate (XXX.XXXX / Hour)
            // Pattern breakdown:
            //   (\d+\.?\d*) - Captured group for the rate:
            //     \d+ - One or more digits (required)
            //     \.? - Optional decimal point
            //     \d* - Zero or more decimal digits (allows "31.25" or "31")
            //   \s* - Zero or more whitespace characters
            //   \/ - Literal forward slash
            //   \s* - Zero or more whitespace characters
            //   Hour - Literal text "Hour" (case-insensitive due to 'i' flag)
            // Matches: "31.25 / Hour", "31.25/Hour", "31 / Hour"
            const hourlyPattern = /(\d+\.?\d*)\s*\/\s*Hour/i;
            const hourlyMatch = text.match(hourlyPattern);
            let hourlyRate = 0;
            if (hourlyMatch) {
                const parsedRate = parseFloat(hourlyMatch[1]);
                hourlyRate = parsedRate > 0 ? validateSalaryRange(parsedRate, 'hourlyRate') : 0;
            }
            
            // Extract percentage - it's the last decimal number in the string
            // Look for pattern like "12.2807" or "0.0000" at the end (after last $X.XX amount)
            // Pattern breakdown:
            //   (\d+\.\d{4}) - Captured group:
            //     \d+ - One or more digits (e.g., "12" or "0")
            //     \. - Literal decimal point
            //     \d{4} - Exactly 4 decimal digits (Paylocity uses 4 decimals for percentages: "12.2807")
            //   \s* - Zero or more whitespace characters
            //   $ - End of string anchor (ensures we match the last number only)
            // Example: "01/15/2023 Merit Increase $2,500.0065,000.0031.2512.2807" matches "12.2807"
            const percentPattern = /(\d+\.\d{4})\s*$/;
            const percentMatch = text.trim().match(percentPattern);
            let changePercent = 0;
            if (percentMatch) {
                changePercent = parseFloat(percentMatch[1]);
            } else {
                // Fallback: try to find any percentage-like number at end
                // Pattern: (\d+\.?\d*)\s*$ matches any decimal number at the end
                //   \d+ - One or more digits (required)
                //   \.? - Optional decimal point
                //   \d* - Zero or more decimal digits (allows "12.28" or "12")
                //   \s* - Zero or more whitespace
                //   $ - End of string anchor
                // Used when main percentPattern fails (e.g., percentage has fewer than 4 decimals)
                const fallbackMatch = text.trim().match(/(\d+\.?\d*)\s*$/);
                if (fallbackMatch) {
                    const potential = parseFloat(fallbackMatch[1]);
                    if (potential < 100) {
                        changePercent = potential;
                    }
                }
            }
            
            // Validate we have minimum required data
            if (annual === 0) {
                return null;
            }
            
            return {
                date,
                reason,
                perCheck,
                annual,
                hourlyRate,
                change,
                changePercent
            };
        }

        // ========================================
        // PARSE AND GENERATE
        // ========================================
        
        function parseAndGenerate() {
            const input = document.getElementById('pasteInput').value.trim();
            const messageDiv = document.getElementById('validationMessage');
            
            if (!input) {
                messageDiv.className = 'validation-message error visible';
                messageDiv.textContent = ' Please paste your Paylocity data first.';
                return;
            }
            
            try {
                employeeData = parsePaylocityData(input);
                
                if (employeeData.records.length < 2) {
                    throw new Error('Need at least 2 records to generate insights');
                }
                
                // Check if there are any actual adjustments (not just New Hire)
                const adjustments = employeeData.records.filter(r => r.reason !== 'New Hire');
                if (adjustments.length === 0) {
                    throw new Error('No salary adjustments found. You may be too new to have raise history yet');
                }
                
                employeeData.isDemo = false;
                messageDiv.className = 'validation-message';
                showDashboard();
                // Hide demo banner for real data
                document.getElementById('demoBanner').classList.add('hidden');
                // Update URL (removes demo flag)
                updateUrlParams();
            } catch (e) {
                console.error('Parse error:', e);
                messageDiv.className = 'validation-message error visible';
                messageDiv.textContent = ` ${e.message}. Please make sure you copied from "Rates" down to "items".`;
            }
        }

        // ========================================
        // REAL-TIME VALIDATION
        // ========================================
        
        function validatePasteInput() {
            const input = document.getElementById('pasteInput').value.trim();
            const messageDiv = document.getElementById('validationMessage');
            const generateBtn = document.getElementById('generateBtn');
            
            if (!input) {
                messageDiv.className = 'validation-message';
                messageDiv.textContent = '';
                generateBtn.disabled = true;
                return;
            }
            
            // Check for date patterns (MM/DD/YYYY)
            const datePattern = /\d{2}\/\d{2}\/\d{4}/g;
            const dates = input.match(datePattern) || [];
            
            // Check for dollar amounts with exactly 2 decimal places (standard currency)
            const dollarPattern = /\$[0-9,]+\.\d{2}/g;
            const dollars = input.match(dollarPattern) || [];
            
            // Check for key structural indicators
            const hasRates = /rates/i.test(input);
            const hasCurrent = /current/i.test(input);
            const hasHistory = /history/i.test(input);
            const hasItems = /items/i.test(input);
            const hasSalary = /salary/i.test(input);
            
            // Validation checks
            if (dates.length === 0) {
                messageDiv.className = 'validation-message error visible';
                messageDiv.textContent = ' No dates found. Make sure you copied the table data including dates (MM/DD/YYYY format).';
                generateBtn.disabled = true;
                return;
            }
            
            if (dollars.length === 0) {
                messageDiv.className = 'validation-message error visible';
                messageDiv.textContent = ' No salary amounts found. Make sure "Show Private Data" is enabled in Paylocity.';
                generateBtn.disabled = true;
                return;
            }
            
            if (!hasSalary) {
                messageDiv.className = 'validation-message warning visible';
                messageDiv.textContent = ' Data looks incomplete. Make sure you copied from the Rates tab.';
                generateBtn.disabled = false;
                return;
            }
            
            if (!hasHistory && dates.length < 3) {
                messageDiv.className = 'validation-message warning visible';
                messageDiv.textContent = ' Only ' + dates.length + ' record(s) found. Did you include the History table?';
                generateBtn.disabled = false;
                return;
            }
            
            if (dollars.length < dates.length) {
                messageDiv.className = 'validation-message warning visible';
                messageDiv.textContent = ' Found ' + dates.length + ' dates but only ' + dollars.length + ' salary values. Some data may be missing.';
                generateBtn.disabled = false;
                return;
            }
            
            // Success
            messageDiv.className = 'validation-message success visible';
            messageDiv.textContent = ' Found ' + dates.length + ' compensation records. Ready to generate!';
            generateBtn.disabled = false;
        }

        // ========================================
        // DEMO DATA - Multiple Scenarios
        // ========================================

        const DEMO_SCENARIOS = [
            {
                id: 1,
                name: "Early Career",
                description: "2 years tenure",
                hireDate: "2023-03-15",
                currentDate: "2025-01-15",
                records: [
                    { date: "2025-01-15", reason: "Merit Increase", perCheck: 3125.00, annual: 75000.00, hourlyRate: 36.06, change: 208.33, changePercent: 7.14 },
                    { date: "2024-03-01", reason: "Merit Increase", perCheck: 2916.67, annual: 70000.00, hourlyRate: 33.65, change: 208.33, changePercent: 7.69 },
                    { date: "2023-09-01", reason: "Equity", perCheck: 2708.33, annual: 65000.00, hourlyRate: 31.25, change: 208.33, changePercent: 8.33 },
                    { date: "2023-03-15", reason: "New Hire", perCheck: 2500.00, annual: 60000.00, hourlyRate: 28.85, change: 0, changePercent: 0 }
                ]
            },
            {
                id: 2,
                name: "Growth Phase",
                description: "5 years tenure",
                hireDate: "2020-02-01",
                currentDate: "2025-01-15",
                records: [
                    { date: "2025-01-15", reason: "Merit Increase", perCheck: 4166.67, annual: 100000.00, hourlyRate: 48.08, change: 375.00, changePercent: 9.89 },
                    { date: "2024-02-15", reason: "Promotion", perCheck: 3791.67, annual: 91000.00, hourlyRate: 43.75, change: 458.33, changePercent: 13.75 },
                    { date: "2023-02-01", reason: "Merit Increase", perCheck: 3333.33, annual: 80000.00, hourlyRate: 38.46, change: 208.33, changePercent: 6.67 },
                    { date: "2022-03-01", reason: "Market Adjustment", perCheck: 3125.00, annual: 75000.00, hourlyRate: 36.06, change: 291.67, changePercent: 10.34 },
                    { date: "2021-02-15", reason: "Merit Increase", perCheck: 2833.33, annual: 68000.00, hourlyRate: 32.69, change: 166.67, changePercent: 5.43 },
                    { date: "2020-08-01", reason: "Equity", perCheck: 2666.67, annual: 64000.00, hourlyRate: 30.77, change: 166.67, changePercent: 6.67 },
                    { date: "2020-02-01", reason: "New Hire", perCheck: 2500.00, annual: 60000.00, hourlyRate: 28.85, change: 0, changePercent: 0 }
                ]
            },
            {
                id: 3,
                name: "Established",
                description: "8 years tenure",
                hireDate: "2017-06-15",
                currentDate: "2025-01-15",
                records: [
                    { date: "2025-01-15", reason: "Merit Increase", perCheck: 5416.67, annual: 130000.00, hourlyRate: 62.50, change: 416.67, changePercent: 8.33 },
                    { date: "2024-01-15", reason: "Merit Increase", perCheck: 5000.00, annual: 120000.00, hourlyRate: 57.69, change: 416.67, changePercent: 9.09 },
                    { date: "2023-02-01", reason: "Promotion", perCheck: 4583.33, annual: 110000.00, hourlyRate: 52.88, change: 625.00, changePercent: 15.38 },
                    { date: "2022-02-15", reason: "Merit Increase", perCheck: 3958.33, annual: 95000.00, hourlyRate: 45.67, change: 291.67, changePercent: 8.11 },
                    { date: "2021-03-01", reason: "Merit Increase", perCheck: 3666.67, annual: 88000.00, hourlyRate: 42.31, change: 250.00, changePercent: 7.32 },
                    { date: "2020-02-15", reason: "Market Adjustment", perCheck: 3416.67, annual: 82000.00, hourlyRate: 39.42, change: 333.33, changePercent: 10.81 },
                    { date: "2019-02-01", reason: "Merit Increase", perCheck: 3083.33, annual: 74000.00, hourlyRate: 35.58, change: 208.33, changePercent: 7.25 },
                    { date: "2018-06-15", reason: "Merit Increase", perCheck: 2875.00, annual: 69000.00, hourlyRate: 33.17, change: 208.33, changePercent: 7.69 },
                    { date: "2017-12-01", reason: "Equity", perCheck: 2666.67, annual: 64000.00, hourlyRate: 30.77, change: 166.67, changePercent: 6.67 },
                    { date: "2017-06-15", reason: "New Hire", perCheck: 2500.00, annual: 60000.00, hourlyRate: 28.85, change: 0, changePercent: 0 }
                ]
            },
            {
                id: 4,
                name: "Senior Tenure",
                description: "12 years tenure",
                hireDate: "2013-01-15",
                currentDate: "2025-01-15",
                records: [
                    { date: "2025-01-15", reason: "Merit Increase", perCheck: 7916.67, annual: 190000.00, hourlyRate: 91.35, change: 416.67, changePercent: 5.56 },
                    { date: "2024-02-01", reason: "Merit Increase", perCheck: 7500.00, annual: 180000.00, hourlyRate: 86.54, change: 416.67, changePercent: 5.88 },
                    { date: "2023-01-15", reason: "Merit Increase", perCheck: 7083.33, annual: 170000.00, hourlyRate: 81.73, change: 416.67, changePercent: 6.25 },
                    { date: "2022-02-15", reason: "Promotion", perCheck: 6666.67, annual: 160000.00, hourlyRate: 76.92, change: 833.33, changePercent: 14.29 },
                    { date: "2021-02-01", reason: "Merit Increase", perCheck: 5833.33, annual: 140000.00, hourlyRate: 67.31, change: 416.67, changePercent: 7.69 },
                    { date: "2020-03-01", reason: "Market Adjustment", perCheck: 5416.67, annual: 130000.00, hourlyRate: 62.50, change: 625.00, changePercent: 12.50 },
                    { date: "2019-02-15", reason: "Merit Increase", perCheck: 4791.67, annual: 115000.00, hourlyRate: 55.29, change: 416.67, changePercent: 9.52 },
                    { date: "2018-02-01", reason: "Promotion", perCheck: 4375.00, annual: 105000.00, hourlyRate: 50.48, change: 625.00, changePercent: 16.22 },
                    { date: "2017-03-01", reason: "Merit Increase", perCheck: 3750.00, annual: 90000.00, hourlyRate: 43.27, change: 291.67, changePercent: 8.43 },
                    { date: "2016-02-15", reason: "Merit Increase", perCheck: 3458.33, annual: 83000.00, hourlyRate: 39.90, change: 208.33, changePercent: 6.49 },
                    { date: "2015-03-01", reason: "Market Adjustment", perCheck: 3250.00, annual: 78000.00, hourlyRate: 37.50, change: 333.33, changePercent: 11.43 },
                    { date: "2014-02-15", reason: "Merit Increase", perCheck: 2916.67, annual: 70000.00, hourlyRate: 33.65, change: 208.33, changePercent: 7.69 },
                    { date: "2013-08-01", reason: "Equity", perCheck: 2708.33, annual: 65000.00, hourlyRate: 31.25, change: 208.33, changePercent: 8.33 },
                    { date: "2013-01-15", reason: "New Hire", perCheck: 2500.00, annual: 60000.00, hourlyRate: 28.85, change: 0, changePercent: 0 }
                ]
            }
        ];

        function loadDemoData(scenarioIndex = null) {
            // If no index provided, use current state index
            if (scenarioIndex === null) {
                scenarioIndex = state.currentScenarioIndex;
            } else {
                state.currentScenarioIndex = scenarioIndex;
            }
            
            const scenario = DEMO_SCENARIOS[scenarioIndex];
            
            employeeData = {
                hireDate: scenario.hireDate,
                currentDate: scenario.currentDate,
                records: [...scenario.records], // Clone to prevent mutation
                isDemo: true,
                scenarioId: scenario.id
            };
            
            showDashboard();
            
            // Update demo banner
            document.getElementById('demoBanner').classList.remove('hidden');
            updateScenarioLabel();
            
            // Update URL
            updateUrlParams();
        }

        function cycleNextScenario() {
            // Move to next scenario (wrap around)
            state.currentScenarioIndex = (state.currentScenarioIndex + 1) % DEMO_SCENARIOS.length;
            
            // Destroy existing charts before regenerating
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = { main: null, yoy: null, category: null, projection: null };
            
            // Load the new scenario
            loadDemoData(state.currentScenarioIndex);
        }

        function updateScenarioLabel() {
            const scenario = DEMO_SCENARIOS[state.currentScenarioIndex];
            const label = document.getElementById('scenarioLabel');
            if (label) {
                label.textContent = `Scenario ${scenario.id}: ${scenario.name} (${scenario.description})`;
            }
        }

        // ========================================
        // FILE HANDLING
        // ========================================
        
        function loadJsonFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    employeeData = JSON.parse(e.target.result);
                    if (!employeeData.records || !employeeData.hireDate) {
                        throw new Error('Invalid data format');
                    }
                    employeeData.isDemo = false;
                    showDashboard();
                    // Hide demo banner for loaded data
                    document.getElementById('demoBanner').classList.add('hidden');
                    // Update URL (removes demo flag)
                    updateUrlParams();
                } catch (err) {
                    alert('Error loading file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function downloadData() {
            if (!employeeData) return;
            
            const dataStr = JSON.stringify(employeeData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'compensation-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========================================
        // VIEW SWITCHING
        // ========================================
        
        function showDashboard() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            window.scrollTo(0, 0);
            initDashboard();
            checkInitialHash(); // Check URL hash for tab navigation

            // Focus management for accessibility - move focus to dashboard heading
            setTimeout(() => {
                const heading = document.querySelector('.logo-text h1');
                if (heading) {
                    heading.setAttribute('tabindex', '-1');
                    heading.focus();
                }
            }, 100);
        }
        
        function resetDashboard() {
            // Destroy all charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = { main: null, yoy: null, category: null, projection: null };
            
            // Reset state
            state.currentTab = 'home';
            employeeData = null;
            
            // Update URL - keep theme, remove demo
            const params = new URLSearchParams();
            params.set('theme', state.theme);
            history.replaceState(null, '', `${window.location.pathname}?${params.toString()}`);
            
            // Show landing page
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('landingPage').classList.remove('hidden');
            
            // Clear paste area and validation
            document.getElementById('pasteInput').value = '';
            document.getElementById('validationMessage').className = 'validation-message';
            document.getElementById('generateBtn').disabled = true;
        }

        // ========================================
        // STORY CONTENT
        // ========================================
        
        const storyContent = {
            tactical: {
                title: "Mission Debrief: Compensation Trajectory",
                subtitle: "Classification: Personnel Valuation Report",
                getText: (data) => `
                    <p><span class="story-highlight">MISSION START:</span> Specialist deployed on <span class="story-stat">${data.hireDateFormatted}</span> with initial resource allocation of <span class="story-stat">${data.startSalary}</span>. Operational status: New Hire. Initial positioning established within standard parameters for role classification.</p>
                    
                    <p><span class="story-highlight">OPERATIONAL SUMMARY:</span> Over <span class="story-stat">${data.years} years</span> of continuous deployment, the specialist has demonstrated consistent value appreciation. Total resource adjustments: <span class="story-stat">${data.totalAdjustments} modifications</span>. Current valuation stands at <span class="story-stat">${data.currentSalary}</span>, representing a <span class="story-stat">${data.growth}%</span> increase from baseline. Adjustment frequency exceeds standard annual review cycles, indicating active performance recognition protocols.</p>
                    
                    <p><span class="story-highlight">PERFORMANCE METRICS:</span> Compound Annual Growth Rate (CAGR) calculated at <span class="story-stat">${data.cagr}%</span>. Average interval between resource reallocations: <span class="story-stat">${data.avgInterval} months</span>. Primary adjustment category: Merit-based (${data.meritPercent}% of all modifications). Remaining adjustments attributed to promotions, market corrections, and role transitions. Cumulative inflation during deployment period: <span class="story-stat">${data.cumulativeInflation}%</span>. Inflation-adjusted growth rate: <span class="story-stat">${data.realGrowth}%</span>, confirming real value appreciation beyond cost-of-living factors.</p>
                    
                    <p><span class="story-highlight">NOTABLE OPERATIONS:</span> Largest single-event appreciation occurred <span class="story-stat">${data.largestRaiseDate}</span> with a <span class="story-stat">${data.largestRaise}%</span> value increase.${data.sixFigureDate ? ` Six-figure threshold breached <span class="story-stat">${data.sixFigureDate}</span>, achieved within <span class="story-stat">${data.yearsToSixFigures}</span> of initial deployment.` : ''} Compensation trajectory has maintained positive momentum across all recorded intervals.</p>
                    
                    <p><span class="story-highlight">STATUS:</span> Specialist remains in active deployment. Current trajectory sustainable pending continued performance alignment. See <a href="#market" onclick="setTab('market'); return false;" class="tab-link">Market</a> tab for industry benchmarks and inflation-adjusted analysis.</p>
                    
                    <div class="story-insight">
                        <span class="story-insight-label">Advisory Note</span>
                        Compensation metrics represent one vector in a multi-dimensional assessment matrix. Operational impact, skill acquisition, and mission value are tracked through separate channels. This system monitors resource allocation only; comprehensive specialist evaluation requires additional data streams not captured in this report.
                    </div>
                `
            },
            artistic: {
                title: "Compensation Summary",
                getSubtitle: (data) => data.dateRange,
                getText: (data) => `
                    <p>You started at <span class="story-stat">${data.startSalary}</span> on <span class="story-stat">${data.hireDateFormatted}</span>. Your current annual salary is <span class="story-stat">${data.currentSalary}</span>an increase of <span class="story-stat">${data.dollarIncrease}</span> from your starting point.</p>
                    
                    <p>Over <span class="story-stat">${data.years} years</span>, your compensation has increased <span class="story-stat">${data.growth}%</span> through <span class="story-stat">${data.totalAdjustments} adjustments</span>. That works out to a compound annual growth rate (CAGR) of <span class="story-stat">${data.cagr}%</span>, with adjustments occurring roughly every <span class="story-stat">${data.avgInterval} months</span> on averagemore frequently than the typical annual review cycle.</p>
                    
                    <p><span class="story-stat">${data.meritPercent}%</span> of your adjustments were merit-based, with the remainder coming from promotions, market adjustments, or role changes. Your largest single increase was <span class="story-stat">${data.largestRaise}%</span> in <span class="story-stat">${data.largestRaiseDate}</span>.${data.sixFigureDate ? ` You crossed the six-figure threshold in <span class="story-stat">${data.sixFigureDate}</span>, about <span class="story-stat">${data.yearsToSixFigures}</span> into your tenure.` : ''}</p>
                    
                    <p>Accounting for <span class="story-stat">${data.cumulativeInflation}%</span> cumulative inflation over this period, your real purchasing power has grown by approximately <span class="story-stat">${data.realGrowth}%</span>. In other words, your raises have ${parseFloat(data.realGrowth) > 0 ? 'outpaced' : 'not kept pace with'} the cost of living.</p>
                    
                    <p>For context on how these numbers compare to industry standards, see the <a href="#market" onclick="setTab('market'); return false;" class="tab-link">Market</a> tab. The <a href="#analytics" onclick="setTab('analytics'); return false;" class="tab-link">Analytics</a> tab provides additional breakdowns of your raise history and patterns over time.</p>
                    
                    <div class="story-insight">
                        <span class="story-insight-label">Note</span>
                        This summary tracks compensation only. Career growth encompasses many thingsskills developed, problems solved, teams built, impact madethat aren't captured in salary data alone. The numbers here tell one part of the story.
                    </div>
                `
            }
        };

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        /**
         * Wraps chart build functions with error handling.
         * Prevents chart rendering failures from crashing the entire app.
         *
         * @param {Function} buildFn - The chart build function to wrap
         * @param {string} chartName - Name of the chart for error messages
         * @returns {Function} Wrapped function with error handling
         *
         * @example
         * const safeBuildChart = withChartErrorHandling(buildMainChart, 'Main Chart');
         * safeBuildChart(); // Catches and logs any errors
         */
        function withChartErrorHandling(buildFn, chartName) {
            return function() {
                try {
                    return buildFn.apply(this, arguments);
                } catch (error) {
                    console.error(`${chartName} rendering failed:`, error);
                    showUserMessage(`${chartName} could not be rendered. Please refresh the page.`, 'warning');
                }
            };
        }

        /**
         * Displays a user-facing message banner at the top of the page.
         * Automatically removes after 5 seconds.
         *
         * @param {string} message - The message to display
         * @param {string} type - Message type: 'error', 'warning', 'success', 'info'
         *
         * @example
         * showUserMessage('Chart rendering failed. Try refreshing.', 'error');
         * showUserMessage('Data saved successfully!', 'success');
         */
        function showUserMessage(message, type = 'error') {
            // Remove any existing messages
            document.querySelectorAll('.user-message').forEach(el => el.remove());

            const banner = document.createElement('div');
            banner.className = `user-message user-message-${type}`;
            banner.innerHTML = `
                <span>${escapeHTML(message)}</span>
                <button onclick="this.parentElement.remove()" aria-label="Dismiss message"></button>
            `;
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 10000;
                padding: 1rem 2rem;
                background: ${type === 'error' ? '#d32f2f' : type === 'warning' ? '#f57c00' : type === 'success' ? '#388e3c' : '#1976d2'};
                color: white;
                text-align: center;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            banner.querySelector('button').style.cssText = `
                background: transparent;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0 0.5rem;
                margin-left: 1rem;
            `;

            document.body.prepend(banner);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (banner.parentElement) {
                    banner.remove();
                }
            }, 5000);
        }
        
        function formatCurrency(amount, showDollars = state.showDollars) {
            if (showDollars) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            }
            const startingSalary = getStartingSalary();
            const index = (amount / startingSalary) * 100;
            return index.toFixed(0);
        }

        function formatPercent(value) {
            return value.toFixed(1) + '%';
        }

        function getStartingSalary() {
            return employeeData.records[employeeData.records.length - 1].annual;
        }

        function getCurrentSalary() {
            return employeeData.records[0].annual;
        }

        /**
         * Calculates Compound Annual Growth Rate (CAGR) for total compensation.
         *
         * CAGR represents the mean annual growth rate over the entire tenure,
         * smoothing out year-to-year variations. Formula: ((End / Start)^(1/Years)) - 1
         *
         * **Security/Stability Protection:**
         * - Guards against division by zero (years = 0, start = 0)
         * - Returns 0 for invalid inputs (negative salaries, zero tenure)
         * - Uses simple percentage for very short tenure (<36 days)
         * - Prevents NaN/Infinity propagation that would crash UI
         *
         * @returns {number} CAGR as percentage (e.g., 8.5 for 8.5%)
         *
         * @example
         * // Starting salary: $60,000, Current: $100,000, Years: 5
         * const cagr = calculateCAGR();
         * console.log(cagr); // ~10.8% annual growth
         *
         * @example
         * // Edge case: Same-day hire and export (years = 0)
         * const cagr = calculateCAGR();
         * console.log(cagr); // 0 (graceful fallback)
         */
        function calculateCAGR() {
            const start = getStartingSalary();
            const end = getCurrentSalary();
            const years = calculateYearsOfService();

            // Validation: Prevent division by zero and NaN propagation
            if (years <= 0 || start <= 0 || end <= 0) {
                if (years <= 0 || start <= 0 || end <= 0) {
                    console.warn('calculateCAGR: Invalid inputs, returning 0', { start, end, years });
                }
                return 0; // Graceful fallback
            }

            // For very short tenure (<~36 days), use simple percentage instead of CAGR
            // This avoids extreme CAGR values from compounding over very short periods
            if (years < 0.1) {
                return ((end - start) / start) * 100;
            }

            return (Math.pow(end / start, 1 / years) - 1) * 100;
        }

        function calculateYearsOfService() {
            const hire = new Date(employeeData.hireDate);
            const current = new Date(employeeData.currentDate);
            return (current - hire) / (1000 * 60 * 60 * 24 * 365.25);
        }

        function getThemeColors() {
            const style = getComputedStyle(document.documentElement);
            return {
                line1: style.getPropertyValue('--chart-line-1').trim(),
                line2: style.getPropertyValue('--chart-line-2').trim(),
                fill1: style.getPropertyValue('--chart-fill-1').trim(),
                fill2: style.getPropertyValue('--chart-fill-2').trim(),
                grid: style.getPropertyValue('--chart-grid').trim(),
                text: style.getPropertyValue('--text-secondary').trim(),
                accent: style.getPropertyValue('--accent-primary').trim()
            };
        }

        // ========================================
        // MILESTONES DETECTION
        // ========================================
        
        function detectMilestones() {
            const milestones = [];
            const records = [...employeeData.records].reverse();
            const startingSalary = getStartingSalary();
            
            // Six figures
            const sixFigures = records.find(r => r.annual >= 100000);
            if (sixFigures) {
                milestones.push({
                    icon: '',
                    title: 'Six Figures',
                    detail: 'Crossed $100,000 annual salary',
                    date: new Date(sixFigures.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                });
            }

            // Salary doubled
            const doubled = records.find(r => r.annual >= startingSalary * 2);
            if (doubled) {
                const doubledDate = new Date(doubled.date);
                const hireDate = new Date(employeeData.hireDate);
                const monthsToDouble = Math.round((doubledDate - hireDate) / (1000 * 60 * 60 * 24 * 30));
                milestones.push({
                    icon: '',
                    title: 'Salary Doubled',
                    detail: `Reached 2 starting salary in ${monthsToDouble} months`,
                    date: doubledDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                });
            }

            // $200k milestone
            const twoHundredK = records.find(r => r.annual >= 200000);
            if (twoHundredK) {
                milestones.push({
                    icon: '',
                    title: '$200K Milestone',
                    detail: 'Crossed $200,000 annual salary',
                    date: new Date(twoHundredK.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                });
            }

            // Biggest raise
            const raises = employeeData.records.filter(r => r.changePercent > 0);
            if (raises.length > 0) {
                const biggestRaise = raises.reduce((max, r) => r.changePercent > max.changePercent ? r : max);
                milestones.push({
                    icon: '',
                    title: 'Largest Raise',
                    detail: `${biggestRaise.changePercent.toFixed(1)}% increase`,
                    date: new Date(biggestRaise.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                });
            }

            // 10 year mark
            const years = calculateYearsOfService();
            if (years >= 10) {
                milestones.push({
                    icon: '',
                    title: 'Decade of Service',
                    detail: '10+ years with the organization',
                    date: new Date(new Date(employeeData.hireDate).getTime() + 10 * 365.25 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                });
            }

            return milestones;
        }

        // ========================================
        // THEME FUNCTIONS
        // ========================================
        
        function updateChartTheme(chart) {
            if (!chart) return;

            const colors = getThemeColors();

            // Update dataset colors
            chart.data.datasets.forEach((dataset) => {
                // Update border colors
                if (dataset.borderColor) {
                    // Check if it's using a theme-specific color that needs updating
                    const isDynamicColor = dataset.borderColor.includes('rgb') ||
                                          dataset.borderColor.includes('#');
                    if (isDynamicColor) {
                        // For main datasets, use primary colors
                        if (dataset.label?.includes('Annual Salary') || dataset.label?.includes('Index Value')) {
                            dataset.borderColor = colors.line1;
                            dataset.pointBackgroundColor = colors.line1;
                            dataset.pointBorderColor = colors.line1;
                        } else if (dataset.label?.includes('YoY Growth')) {
                            dataset.borderColor = colors.line2;
                        } else if (dataset.label?.includes('Historical CAGR')) {
                            dataset.borderColor = colors.line1;
                        } else if (dataset.label?.includes('Custom')) {
                            dataset.borderColor = colors.line2;
                        } else if (dataset.label?.includes('Conservative')) {
                            dataset.borderColor = state.theme === 'tactical' ? '#666' : '#8a837a';
                        } else if (dataset.label?.includes('Optimistic')) {
                            dataset.borderColor = state.theme === 'tactical' ? '#4598d4' : '#7b2cbf';
                        }
                    }
                }

                // Update background colors for bar/area charts
                if (dataset.backgroundColor && dataset.backgroundColor !== 'transparent') {
                    if (state.mainChartType === 'area') {
                        dataset.backgroundColor = colors.fill1;
                    } else if (state.mainChartType === 'bar') {
                        dataset.backgroundColor = colors.line1;
                    } else if (state.yoyChartType === 'bar') {
                        dataset.backgroundColor = colors.line2;
                    }
                }
            });

            // Update grid and axis colors
            if (chart.options.scales) {
                Object.keys(chart.options.scales).forEach(scaleKey => {
                    const scale = chart.options.scales[scaleKey];
                    if (scale.grid) {
                        scale.grid.color = colors.grid;
                    }
                    if (scale.ticks) {
                        scale.ticks.color = colors.text;
                    }
                });
            }

            // Update tooltip colors
            if (chart.options.plugins?.tooltip) {
                chart.options.plugins.tooltip.backgroundColor = state.theme === 'tactical' ? '#1a1a1d' : '#ffffff';
                chart.options.plugins.tooltip.titleColor = state.theme === 'tactical' ? '#e8e8e8' : '#2d2a26';
                chart.options.plugins.tooltip.bodyColor = state.theme === 'tactical' ? '#a0a0a0' : '#5c5650';
                chart.options.plugins.tooltip.borderColor = state.theme === 'tactical' ? '#2a2a2d' : '#e8e2da';
            }

            // Update legend colors
            if (chart.options.plugins?.legend?.labels) {
                chart.options.plugins.legend.labels.color = colors.text;
            }

            // Update category chart border color
            if (chart.config.type === 'doughnut') {
                chart.data.datasets.forEach(dataset => {
                    dataset.borderColor = state.theme === 'tactical' ? '#141416' : '#ffffff';
                });
            }

            // Fast update without animation
            chart.update('none');
        }

        function setTheme(theme) {
            state.theme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            
            // Update all theme buttons
            document.querySelectorAll('.theme-btn, .landing-theme-btn').forEach(btn => {
                const isActive = btn.dataset.theme === theme;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive);
            });
            
            // Update URL
            updateUrlParams();

            if (employeeData) {
                updateStory();
                // Instantly update chart colors without rebuilding (performance optimization)
                updateChartTheme(charts.main);
                updateChartTheme(charts.yoy);
                updateChartTheme(charts.category);
                updateChartTheme(charts.projection);
            }
        }

        // ========================================
        // VIEW MODE (DOLLARS / INDEX)
        // ========================================
        
        function setViewMode(mode) {
            state.showDollars = (mode === 'dollars');
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                const isActive = btn.dataset.view === mode;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive);
            });
            
            updateAllDisplays();
            updateUrlParams();
        }
        
        function togglePrivacy() {
            // Toggle for keyboard shortcut
            setViewMode(state.showDollars ? 'index' : 'dollars');
        }

        function updateAllDisplays() {
            const current = getCurrentSalary();
            const start = getStartingSalary();
            
            document.getElementById('currentSalary').textContent = state.showDollars 
                ? formatCurrency(current) 
                : `Index: ${formatCurrency(current, false)}`;
            
            document.getElementById('currentSalaryIndexed').textContent = state.showDollars 
                ? `Index: ${formatCurrency(current, false)}` 
                : `Base 100 = Starting salary`;

            buildHistoryTable();
            updateAnalytics();
            updateStory();
            buildMainChart();
            if (charts.projection) {
                buildProjectionChart();
                buildProjectionTable();
            }
        }

        // ========================================
        // STORY UPDATE
        // ========================================
        
        function updateStory() {
            const content = storyContent[state.theme];
            document.getElementById('storyTitle').textContent = content.title;
            
            const start = getStartingSalary();
            const current = getCurrentSalary();
            const growth = ((current - start) / start) * 100;
            const cagr = calculateCAGR();
            const years = calculateYearsOfService();
            
            // Exclude "New Hire" - it's the starting point, not an adjustment
            const adjustments = employeeData.records.filter(r => r.reason !== 'New Hire');
            
            const raises = employeeData.records.filter(r => r.changePercent > 0);
            const largestRaise = raises.length > 0 ? raises.reduce((max, r) => r.changePercent > max.changePercent ? r : max) : null;
            
            const meritCount = adjustments.filter(r => r.reason.includes('Merit')).length;
            const meritPercent = adjustments.length > 0 ? ((meritCount / adjustments.length) * 100).toFixed(1) : '0';
            
            // Calculate avg interval (exclude New Hire from time calculation)
            const dates = adjustments.map(r => new Date(r.date)).sort((a, b) => a - b);
            let totalDays = 0;
            for (let i = 1; i < dates.length; i++) {
                totalDays += (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
            }
            const avgMonths = dates.length > 1 ? (totalDays / (dates.length - 1)) / 30.44 : 0;
            
            // Find six figure date and calculate time to reach it
            const recordsChron = [...employeeData.records].reverse();
            const sixFigures = recordsChron.find(r => r.annual >= 100000);
            let yearsToSixFigures = null;
            if (sixFigures) {
                const hireDate = new Date(employeeData.hireDate);
                const sixFigDate = new Date(sixFigures.date);
                const diffYears = (sixFigDate - hireDate) / (1000 * 60 * 60 * 24 * 365.25);
                yearsToSixFigures = diffYears < 1 ? `${Math.round(diffYears * 12)} months` : `${diffYears.toFixed(1)} years`;
            }
            
            // Calculate inflation data (use employeeData.currentDate, not current real date)
            const startYear = new Date(employeeData.hireDate).getFullYear();
            const startMonth = new Date(employeeData.hireDate).getMonth();
            const endYear = new Date(employeeData.currentDate).getFullYear();
            const endMonth = new Date(employeeData.currentDate).getMonth();
            const cumulativeInflation = calculateInflationOverPeriod(startYear, endYear, startMonth, endMonth);
            const realGrowth = calculateRealGrowth(growth, cumulativeInflation);
            const dollarIncrease = current - start;
            
            const data = {
                hireDateFormatted: new Date(employeeData.hireDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                startSalary: state.showDollars ? formatCurrency(start) : 'Index 100',
                currentSalary: state.showDollars ? formatCurrency(current) : `Index ${formatCurrency(current, false)}`,
                dollarIncrease: state.showDollars ? formatCurrency(dollarIncrease) : `Index ${(dollarIncrease / start * 100).toFixed(0)}`,
                years: years.toFixed(1),
                totalAdjustments: adjustments.length,
                growth: growth.toFixed(0),
                cagr: cagr.toFixed(1),
                avgInterval: avgMonths.toFixed(1),
                meritPercent,
                largestRaiseDate: largestRaise ? new Date(largestRaise.date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'N/A',
                largestRaise: largestRaise ? largestRaise.changePercent.toFixed(1) : '0',
                sixFigureDate: sixFigures ? new Date(sixFigures.date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : null,
                yearsToSixFigures,
                cumulativeInflation: cumulativeInflation.toFixed(1),
                realGrowth: realGrowth.toFixed(1),
                dateRange: new Date(employeeData.hireDate).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) + '  Present'
            };
            
            // Set subtitle (static for tactical, dynamic for summary)
            const subtitle = content.getSubtitle ? content.getSubtitle(data) : content.subtitle;
            document.getElementById('storySubtitle').textContent = subtitle;
            
            document.getElementById('storyText').innerHTML = content.getText(data);
            buildMilestones();
        }

        /**
         * Updates the Market tab with benchmark comparisons and performance analysis.
         *
         * Compares user's CAGR, average raises, and real growth against B2B SaaS
         * industry benchmarks. Generates performance tier (high/solid/low) and
         * theme-appropriate headline. Renders comparison cards and inflation analysis.
         *
         * @global {Object} benchmarks - Industry benchmark data (CAGR, typical raises)
         * @global {Object} state - UI state (theme for tactical vs artistic styling)
         * @returns {void}
         *
         * @example
         * // After parsing data, call to render market comparison
         * updateMarket(); // Populates #marketSummaryCard with performance analysis
         */
        function updateMarket() {
            const bench = getBenchmarkComparisons();
            if (!bench) return;

            const start = getStartingSalary();
            const current = getCurrentSalary();
            const years = calculateYearsOfService();
            
            // Update header based on theme
            const isOutperforming = bench.cagrVsIndustry > 0 && bench.realGrowth > 0;
            const summaryCard = document.getElementById('marketSummaryCard');
            summaryCard.className = 'market-summary-card ' + (isOutperforming ? 'outperforming' : bench.cagrVsIndustry < -1 ? 'underperforming' : '');
            
            // Generate summary headline
            let headline, detail;
            if (bench.performanceTier === 'high') {
                headline = state.theme === 'tactical' 
                    ? 'PERFORMANCE STATUS: EXCEEDING BENCHMARKS'
                    : 'Your growth outpaces the industry';
                detail = `Your <strong>${bench.userCagr.toFixed(1)}% CAGR</strong> exceeds the B2B SaaS benchmark of ${benchmarks.industryCagr}%. With raises averaging <strong>${bench.avgRaise.toFixed(1)}%</strong> (above the typical ${benchmarks.typicalRaise.min}-${benchmarks.typicalRaise.max}% range), your compensation trajectory demonstrates exceptional growth.`;
            } else if (bench.performanceTier === 'solid') {
                headline = state.theme === 'tactical'
                    ? 'PERFORMANCE STATUS: MEETING STANDARDS'
                    : 'Tracking with industry benchmarks';
                detail = `Your <strong>${bench.userCagr.toFixed(1)}% CAGR</strong> ${bench.cagrVsIndustry >= 0 ? 'meets' : 'approaches'} the B2B SaaS benchmark of ${benchmarks.industryCagr}%. With raises averaging <strong>${bench.avgRaise.toFixed(1)}%</strong>, your compensation growth aligns with industry norms.`;
            } else {
                headline = state.theme === 'tactical'
                    ? 'PERFORMANCE STATUS: OPPORTUNITY IDENTIFIED'
                    : 'Room to grow toward benchmarks';
                detail = `Your <strong>${bench.userCagr.toFixed(1)}% CAGR</strong> trails the B2B SaaS benchmark of ${benchmarks.industryCagr}%. With raises averaging <strong>${bench.avgRaise.toFixed(1)}%</strong>, there may be opportunity to negotiate stronger increases.`;
            }
            
            document.getElementById('marketSummaryHeadline').textContent = headline;
            document.getElementById('marketSummaryDetail').innerHTML = detail;
            
            // Build comparison cards
            buildMarketComparison();
            
            // Build inflation analysis
            buildInflationAnalysis(bench, start, current, years);
        }

        function buildInflationAnalysis(bench, start, current, years) {
            const container = document.getElementById('inflationAnalysis');
            const nominalGrowth = ((current - start) / start) * 100;
            
            container.innerHTML = `
                <div class="inflation-card">
                    <div class="inflation-card-title">Cumulative Inflation</div>
                    <div class="inflation-card-value">${bench.totalInflation.toFixed(1)}%</div>
                    <div class="inflation-card-label">CPI increase over ${years.toFixed(1)} years</div>
                    <div class="inflation-breakdown">
                        <div class="inflation-row">
                            <span class="inflation-row-label">Your nominal growth</span>
                            <span class="inflation-row-value">${nominalGrowth.toFixed(1)}%</span>
                        </div>
                        <div class="inflation-row">
                            <span class="inflation-row-label">Minus inflation</span>
                            <span class="inflation-row-value">-${bench.totalInflation.toFixed(1)}%</span>
                        </div>
                        <div class="inflation-row" style="border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.25rem;">
                            <span class="inflation-row-label"><strong>Real growth</strong></span>
                            <span class="inflation-row-value ${bench.realGrowth >= 0 ? 'positive' : 'negative'}"><strong>${bench.realGrowth >= 0 ? '+' : ''}${bench.realGrowth.toFixed(1)}%</strong></span>
                        </div>
                    </div>
                </div>
                <div class="inflation-card">
                    <div class="inflation-card-title">Purchasing Power ${bench.purchasingPowerGain >= 0 ? 'Gained' : 'Lost'}</div>
                    <div class="inflation-card-value ${bench.purchasingPowerGain >= 0 ? 'positive' : 'negative'}">${state.showDollars ? (bench.purchasingPowerGain >= 0 ? '+' : '') + formatCurrency(bench.purchasingPowerGain) : (bench.purchasingPowerGain >= 0 ? '+' : '') + (bench.purchasingPowerGain / start * 100).toFixed(0) + ' pts'}</div>
                    <div class="inflation-card-label">In today's dollars</div>
                    <div class="inflation-breakdown">
                        <div class="inflation-row">
                            <span class="inflation-row-label">Starting salary (then)</span>
                            <span class="inflation-row-value">${state.showDollars ? formatCurrency(start) : '100'}</span>
                        </div>
                        <div class="inflation-row">
                            <span class="inflation-row-label">Adjusted for inflation (now)</span>
                            <span class="inflation-row-value">${state.showDollars ? formatCurrency(bench.inflationAdjustedStart) : Math.round(bench.inflationAdjustedStart / start * 100)}</span>
                        </div>
                        <div class="inflation-row">
                            <span class="inflation-row-label">Current salary</span>
                            <span class="inflation-row-value">${state.showDollars ? formatCurrency(current) : Math.round(current / start * 100)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function buildMilestones() {
            const milestones = detectMilestones();
            const grid = document.getElementById('milestonesGrid');

            grid.innerHTML = milestones.map(m => `
                <div class="milestone-card">
                    <div class="milestone-icon">${escapeHTML(m.icon)}</div>
                    <div class="milestone-title">${escapeHTML(m.title)}</div>
                    <div class="milestone-detail">${escapeHTML(m.detail)}</div>
                    <div class="milestone-date">${escapeHTML(m.date)}</div>
                </div>
            `).join('');
        }

        function buildMarketComparison() {
            const grid = document.getElementById('marketComparisonGrid');
            const bench = getBenchmarkComparisons();
            
            if (!bench) {
                grid.innerHTML = '<p style="color: var(--text-muted);">Unable to calculate market comparisons.</p>';
                return;
            }
            
            const start = getStartingSalary();
            const current = getCurrentSalary();
            
            const cards = [
                {
                    label: 'Your CAGR',
                    value: `${bench.userCagr.toFixed(1)}%`,
                    comparison: `Industry avg: <strong>${benchmarks.industryCagr}%</strong>`,
                    diff: bench.cagrVsIndustry,
                    badge: bench.cagrVsIndustry > 0.5 ? 'above' : bench.cagrVsIndustry < -0.5 ? 'below' : 'at'
                },
                {
                    label: 'Avg Raise',
                    value: `${bench.avgRaise.toFixed(1)}%`,
                    comparison: `Typical range: <strong>${benchmarks.typicalRaise.min}-${benchmarks.typicalRaise.max}%</strong>`,
                    diff: bench.raiseVsTypical,
                    badge: bench.avgRaise > benchmarks.typicalRaise.max ? 'above' : bench.avgRaise >= benchmarks.typicalRaise.min ? 'at' : 'below'
                },
                {
                    label: 'Raise Frequency',
                    value: `${bench.avgMonthsBetween.toFixed(0)} mo`,
                    comparison: `Industry avg: <strong>${benchmarks.avgMonthsBetweenRaises} months</strong>`,
                    diff: benchmarks.avgMonthsBetweenRaises - bench.avgMonthsBetween,
                    badge: bench.avgMonthsBetween < benchmarks.avgMonthsBetweenRaises - 1 ? 'above' : bench.avgMonthsBetween > benchmarks.avgMonthsBetweenRaises + 1 ? 'below' : 'at'
                },
                {
                    label: 'Real Growth',
                    value: `${bench.realGrowth.toFixed(1)}%`,
                    comparison: `After <strong>${bench.totalInflation.toFixed(1)}%</strong> cumulative inflation`,
                    diff: bench.realGrowth,
                    badge: bench.realGrowth > 10 ? 'above' : bench.realGrowth > 0 ? 'at' : 'below'
                },
                {
                    label: 'Purchasing Power',
                    value: state.showDollars 
                        ? (bench.purchasingPowerGain >= 0 ? '+' : '') + formatCurrency(bench.purchasingPowerGain)
                        : (bench.purchasingPowerGain >= 0 ? '+' : '') + (bench.purchasingPowerGain / start * 100).toFixed(0) + ' pts',
                    comparison: `${state.showDollars ? formatCurrency(bench.inflationAdjustedStart) : Math.round(bench.inflationAdjustedStart / start * 100)} would equal start salary today`,
                    diff: bench.purchasingPowerGain,
                    badge: bench.purchasingPowerGain > 0 ? 'above' : bench.purchasingPowerGain < 0 ? 'below' : 'at'
                },
                {
                    label: 'vs Industry Path',
                    value: state.showDollars 
                        ? (bench.vsIndustrySalary >= 0 ? '+' : '') + formatCurrency(bench.vsIndustrySalary)
                        : (bench.vsIndustrySalary >= 0 ? '+' : '') + (bench.vsIndustrySalary / start * 100).toFixed(0) + ' pts',
                    comparison: `At ${benchmarks.industryCagr}% CAGR: <strong>${state.showDollars ? formatCurrency(bench.industryProjectedSalary) : Math.round(bench.industryProjectedSalary / start * 100)}</strong>`,
                    diff: bench.vsIndustrySalary,
                    badge: bench.vsIndustryPercent > 5 ? 'above' : bench.vsIndustryPercent < -5 ? 'below' : 'at'
                }
            ];
            
            grid.innerHTML = cards.map(card => `
                <div class="market-card ${card.diff > 0 ? 'positive' : card.diff < 0 ? 'negative' : 'neutral'}">
                    <div class="market-card-header">
                        <span class="market-card-label">${card.label}</span>
                        <span class="market-card-badge ${card.badge}">${card.badge === 'above' ? ' Above' : card.badge === 'below' ? ' Below' : ' At'}</span>
                    </div>
                    <div class="market-card-value ${card.diff > 0 ? 'positive' : card.diff < 0 ? 'negative' : ''}">${card.value}</div>
                    <div class="market-card-comparison">${card.comparison}</div>
                </div>
            `).join('');
            
            // Update footnote
            document.getElementById('marketFootnote').textContent = `Benchmarks based on B2B SaaS industry data (${benchmarks.lastUpdated}). CPI data from Bureau of Labor Statistics. Individual results vary by role, location, and company stage.`;
        }

        // ========================================
        // TAB FUNCTIONS
        // ========================================
        
        function setTab(tabId, updateUrl = true) {
            state.currentTab = tabId;
            
            // Update URL params for stateful URLs
            if (updateUrl) {
                updateUrlParams();
            }
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.dataset.tab === tabId;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive);
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabId}`);
            });

            if (tabId === 'market') {
                setTimeout(() => {
                    updateMarket();
                }, 100);
            }
            if (tabId === 'analytics' && !charts.yoy) {
                setTimeout(() => {
                    buildYoyChart();
                    buildCategoryChart();
                }, 100);
            }
            if (tabId === 'projections' && !charts.projection) {
                setTimeout(() => {
                    initProjections();
                    buildProjectionChart();
                    buildProjectionTable();
                }, 100);
            }
        }

        // ========================================
        // URL NAVIGATION
        // ========================================
        
        function handleTabFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            const validTabs = ['home', 'story', 'market', 'history', 'analytics', 'projections', 'help'];
            if (tab && validTabs.includes(tab) && employeeData) {
                setTab(tab, false); // false = don't update URL again
            }
        }
        
        // Warn before losing unsaved data
        window.addEventListener('beforeunload', (e) => {
            if (employeeData && !employeeData.isDemo) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        // Check tab on initial dashboard load
        function checkInitialHash() {
            setTimeout(handleTabFromUrl, 100);
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================
        
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (!employeeData) return;
            
            switch(e.key) {
                case '1': setTab('home'); break;
                case '2': setTab('story'); break;
                case '3': setTab('market'); break;
                case '4': setTab('history'); break;
                case '5': setTab('analytics'); break;
                case '6': setTab('projections'); break;
                case '7': setTab('help'); break;
                case 't':
                case 'T': setTheme(state.theme === 'tactical' ? 'artistic' : 'tactical'); break;
                case 'v':
                case 'V':
                case 'p':
                case 'P': togglePrivacy(); break;
            }
        });

        // ========================================
        // CHART FUNCTIONS
        // ========================================
        
        function setChartType(type) {
            state.mainChartType = type;
            document.querySelectorAll('.chart-controls .chart-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.chart === type);
            });
            buildMainChart();
        }

        function setYoyChartType(type) {
            state.yoyChartType = type;
            document.querySelectorAll('[data-chart^="yoy-"]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.chart === `yoy-${type}`);
            });
            buildYoyChart();
        }

        /**
         * Builds the main compensation timeline chart with theme-aware styling.
         *
         * Supports 4 chart types (line, bar, area, step) and 2 view modes (dollars vs indexed).
         * Destroys previous chart instance before creating new one to prevent memory leaks.
         * Automatically adjusts colors, tooltips, and formatting based on current theme.
         *
         * @global {Object} employeeData - Compensation records (from parsePaylocityData)
         * @global {Object} state - UI state (theme, showDollars, mainChartType)
         * @global {Object} charts - Chart.js instances storage
         * @returns {void}
         *
         * @example
         * // After parsing data and setting state
         * state.mainChartType = 'area';
         * state.showDollars = true;
         * buildMainChart(); // Creates new area chart with dollar values
         */
        function buildMainChart() {
            try {
                const canvas = document.getElementById('mainChart');
                if (!canvas) {
                    console.error('buildMainChart: Canvas element not found');
                    showUserMessage('Chart rendering failed. Please refresh the page.', 'error');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('buildMainChart: Canvas 2D context not available');
                    showUserMessage('Chart rendering failed. Your browser may not support this feature.', 'error');
                    return;
                }

                const colors = getThemeColors();

                const data = [...employeeData.records].reverse();

                const labels = data.map(r => {
                    const date = new Date(r.date);
                    return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                });

                const values = data.map(r => state.showDollars ? r.annual : (r.annual / getStartingSalary()) * 100);

                if (charts.main) {
                    charts.main.destroy();
                }

                charts.main = new Chart(ctx, {
                type: state.mainChartType === 'bar' ? 'bar' : 'line',
                data: {
                    labels,
                    datasets: [{
                        label: state.showDollars ? 'Annual Salary' : 'Index Value',
                        data: values,
                        borderColor: colors.line1,
                        backgroundColor: state.mainChartType === 'area' ? colors.fill1 : 
                                        state.mainChartType === 'bar' ? colors.line1 : 'transparent',
                        fill: state.mainChartType === 'area',
                        tension: state.mainChartType === 'step' ? 0 : 0.3,
                        stepped: state.mainChartType === 'step' ? 'before' : false,
                        borderWidth: 2,
                        pointBackgroundColor: colors.line1,
                        pointBorderColor: colors.line1,
                        pointRadius: state.mainChartType === 'bar' ? 0 : 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: state.theme === 'tactical' ? '#1a1a1d' : '#ffffff',
                            titleColor: state.theme === 'tactical' ? '#e8e8e8' : '#2d2a26',
                            bodyColor: state.theme === 'tactical' ? '#a0a0a0' : '#5c5650',
                            borderColor: state.theme === 'tactical' ? '#2a2a2d' : '#e8e2da',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: (ctx) => state.showDollars ? `$${ctx.raw.toLocaleString()}` : `Index: ${ctx.raw.toFixed(0)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: colors.grid, drawBorder: false },
                            ticks: { color: colors.text, maxRotation: 45, minRotation: 45 }
                        },
                        y: {
                            grid: { color: colors.grid, drawBorder: false },
                            ticks: {
                                color: colors.text,
                                callback: (v) => state.showDollars ? '$' + (v / 1000) + 'k' : v
                            }
                        }
                    }
                }
            });

                // Hide loading state
                const loading = document.getElementById('mainChartLoading');
                if (loading) loading.classList.add('hidden');
            } catch (error) {
                console.error('buildMainChart: Chart creation failed', error);
                showUserMessage('Chart rendering failed. Please try refreshing the page.', 'error');

                // Attempt to show a fallback message in the chart container
                const canvas = document.getElementById('mainChart');
                if (canvas && canvas.parentElement) {
                    const fallback = document.createElement('div');
                    fallback.style.cssText = 'padding: 2rem; text-align: center; color: var(--text-muted);';
                    fallback.textContent = 'Chart could not be rendered. Please refresh the page or try a different browser.';
                    canvas.parentElement.appendChild(fallback);
                }
            }
        }

        function buildYoyChart() {
            try {
                const canvas = document.getElementById('yoyChart');
                if (!canvas) {
                    console.error('buildYoyChart: Canvas element not found');
                    showUserMessage('YoY chart rendering failed. Please refresh the page.', 'error');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('buildYoyChart: Canvas 2D context not available');
                    showUserMessage('YoY chart rendering failed. Your browser may not support this feature.', 'error');
                    return;
                }

                const colors = getThemeColors();

                const yoyData = {};
                employeeData.records.forEach(r => {
                    const year = new Date(r.date).getFullYear();
                    if (!yoyData[year]) {
                        yoyData[year] = { start: r.annual, end: r.annual };
                    } else {
                        yoyData[year].start = r.annual;
                    }
                });

                const years = Object.keys(yoyData).sort();
                const growthRates = [];

                for (let i = 1; i < years.length; i++) {
                    const prevYear = years[i - 1];
                    const currYear = years[i];
                    const growth = ((yoyData[currYear].end - yoyData[prevYear].end) / yoyData[prevYear].end) * 100;
                    growthRates.push({ year: currYear, growth });
                }

                if (charts.yoy) charts.yoy.destroy();

                charts.yoy = new Chart(ctx, {
                type: state.yoyChartType,
                data: {
                    labels: growthRates.map(d => d.year),
                    datasets: [{
                        label: 'YoY Growth %',
                        data: growthRates.map(d => d.growth),
                        borderColor: colors.line2,
                        backgroundColor: state.yoyChartType === 'bar' ? colors.line2 : 'transparent',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: state.theme === 'tactical' ? '#1a1a1d' : '#ffffff',
                            titleColor: state.theme === 'tactical' ? '#e8e8e8' : '#2d2a26',
                            bodyColor: state.theme === 'tactical' ? '#a0a0a0' : '#5c5650',
                            borderColor: state.theme === 'tactical' ? '#2a2a2d' : '#e8e2da',
                            borderWidth: 1,
                            callbacks: { label: (ctx) => `${ctx.raw.toFixed(1)}% growth` }
                        }
                    },
                    scales: {
                        x: { grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.text } },
                        y: { grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.text, callback: (v) => v + '%' } }
                    }
                }
            });
            } catch (error) {
                console.error('Failed to build YoY chart:', error);
                showUserMessage('YoY chart rendering failed. Try refreshing the page.', 'error');
            }
        }

        function buildCategoryChart() {
            try {
                const canvas = document.getElementById('categoryChart');
                if (!canvas) {
                    console.error('buildCategoryChart: Canvas element not found');
                    showUserMessage('Category chart rendering failed. Please refresh the page.', 'error');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('buildCategoryChart: Canvas 2D context not available');
                    showUserMessage('Category chart rendering failed. Your browser may not support this feature.', 'error');
                    return;
                }

                const colors = getThemeColors();

                // Filter out "New Hire" - it's the starting point, not an adjustment
                const adjustments = employeeData.records.filter(r => r.reason !== 'New Hire');

                // Guard against no adjustments
                if (adjustments.length === 0) return;

                const categories = {};
                adjustments.forEach(r => {
                    const reason = r.reason || 'Other';
                    if (reason !== '') {
                        categories[reason] = (categories[reason] || 0) + 1;
                    }
                });

                const labels = Object.keys(categories);
                const data = Object.values(categories);

                const categoryColors = [colors.line1, colors.line2,
                    state.theme === 'tactical' ? '#4598d4' : '#7b2cbf',
                    state.theme === 'tactical' ? '#d45745' : '#d00000'];

                if (charts.category) charts.category.destroy();

                charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: categoryColors,
                        borderColor: state.theme === 'tactical' ? '#141416' : '#ffffff',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: colors.text,
                                padding: 20,
                                font: { family: state.theme === 'tactical' ? 'JetBrains Mono' : 'Nunito', size: 12 }
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('Failed to build category chart:', error);
                showUserMessage('Category chart rendering failed. Try refreshing the page.', 'error');
            }
        }

        function initProjections() {
            // Set slider to historical CAGR
            const historicalCAGR = Math.round(calculateCAGR());
            state.cagr = historicalCAGR;
            state.customRate = historicalCAGR;
            
            // Update slider and display
            const slider = document.getElementById('customRateSlider');
            slider.value = historicalCAGR;
            document.getElementById('customRateValue').textContent = historicalCAGR + '%';
            document.getElementById('historicalRateDisplay').textContent = historicalCAGR + '%';
        }

        function buildProjectionChart() {
            try {
                const canvas = document.getElementById('projectionChart');
                if (!canvas) {
                    console.error('buildProjectionChart: Canvas element not found');
                    showUserMessage('Projection chart rendering failed. Please refresh the page.', 'error');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('buildProjectionChart: Canvas 2D context not available');
                    showUserMessage('Projection chart rendering failed. Your browser may not support this feature.', 'error');
                    return;
                }

                const colors = getThemeColors();

                const currentSalary = getCurrentSalary();
                const cagr = calculateCAGR() / 100;
                const years = state.projectionYears;
                const customRate = state.customRate / 100;

                const labels = ['Now'];
                const historical = [currentSalary];
                const conservative = [currentSalary];
                const custom = [currentSalary];
                const optimistic = [currentSalary];

                for (let i = 1; i <= years; i++) {
                    labels.push(`+${i}yr`);
                    historical.push(currentSalary * Math.pow(1 + cagr, i));
                    conservative.push(currentSalary * Math.pow(1.05, i));
                    custom.push(currentSalary * Math.pow(1 + customRate, i));
                    optimistic.push(currentSalary * Math.pow(1.12, i));
                }

                if (charts.projection) charts.projection.destroy();

                charts.projection = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: `Historical CAGR (${(cagr * 100).toFixed(1)}%)`, data: historical, borderColor: colors.line1, backgroundColor: 'transparent', borderWidth: 3, tension: 0.3, pointRadius: 4 },
                        { label: 'Conservative (5%)', data: conservative, borderColor: state.theme === 'tactical' ? '#666' : '#8a837a', backgroundColor: 'transparent', borderWidth: 2, borderDash: [5,5], tension: 0.3, pointRadius: 3 },
                        { label: `Custom (${state.customRate}%)`, data: custom, borderColor: colors.line2, backgroundColor: 'transparent', borderWidth: 2, tension: 0.3, pointRadius: 4 },
                        { label: 'Optimistic (12%)', data: optimistic, borderColor: state.theme === 'tactical' ? '#4598d4' : '#7b2cbf', backgroundColor: 'transparent', borderWidth: 2, borderDash: [5,5], tension: 0.3, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { position: 'top', labels: { color: colors.text, padding: 20, font: { family: state.theme === 'tactical' ? 'JetBrains Mono' : 'Nunito', size: 11 } } },
                        tooltip: {
                            backgroundColor: state.theme === 'tactical' ? '#1a1a1d' : '#ffffff',
                            titleColor: state.theme === 'tactical' ? '#e8e8e8' : '#2d2a26',
                            bodyColor: state.theme === 'tactical' ? '#a0a0a0' : '#5c5650',
                            borderColor: state.theme === 'tactical' ? '#2a2a2d' : '#e8e2da',
                            borderWidth: 1,
                            callbacks: { label: (ctx) => `${ctx.dataset.label}: $${Math.round(ctx.raw).toLocaleString()}` }
                        }
                    },
                    scales: {
                        x: { grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.text } },
                        y: { grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.text, callback: (v) => '$' + (v/1000) + 'k' } }
                    }
                }
            });
            } catch (error) {
                console.error('Failed to build projection chart:', error);
                showUserMessage('Projection chart rendering failed. Try refreshing the page.', 'error');
            }
        }

        // ========================================
        // TABLE FUNCTIONS
        // ========================================
        
        function buildHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            const startingSalary = getStartingSalary();

            tbody.innerHTML = employeeData.records.map(r => {
                const badgeClass = getBadgeClass(r.reason);
                const index = ((r.annual / startingSalary) * 100).toFixed(0);
                const changeDisplay = r.change > 0
                    ? (state.showDollars ? `+${formatCurrency(r.change * 24)}` : `+${((r.change * 24 / startingSalary) * 100).toFixed(1)}`)
                    : '';

                return `
                    <tr>
                        <td>${new Date(r.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td><span class="badge ${badgeClass}">${escapeHTML(r.reason)}</span></td>
                        <td>${state.showDollars ? formatCurrency(r.annual) : `Index: ${index}`}</td>
                        <td>${index}</td>
                        <td>${changeDisplay}</td>
                        <td>${r.changePercent > 0 ? `+${r.changePercent.toFixed(2)}%` : ''}</td>
                    </tr>
                `;
            }).join('');
        }

        function getBadgeClass(reason) {
            if (reason.includes('Merit')) return 'badge-merit';
            if (reason.includes('Equity')) return 'badge-equity';
            if (reason.includes('Market')) return 'badge-market';
            if (reason.includes('New')) return 'badge-new';
            return '';
        }

        function buildProjectionTable() {
            const tbody = document.getElementById('projectionTableBody');
            const currentSalary = getCurrentSalary();
            const cagr = calculateCAGR() / 100;
            const customRate = state.customRate / 100;
            
            // Fixed intervals: 1-5 yearly, then 10, 15, 20
            const intervals = [1, 2, 3, 4, 5, 10, 15, 20];
            
            tbody.innerHTML = intervals.map(year => `
                <tr>
                    <td>${year} year${year > 1 ? 's' : ''}</td>
                    <td>${formatCurrency(currentSalary * Math.pow(1 + cagr, year))}</td>
                    <td>${formatCurrency(currentSalary * Math.pow(1.05, year))}</td>
                    <td>${formatCurrency(currentSalary * Math.pow(1 + customRate, year))}</td>
                    <td>${formatCurrency(currentSalary * Math.pow(1.12, year))}</td>
                </tr>
            `).join('');
        }

        // ========================================
        // ANALYTICS UPDATE
        // ========================================
        
        function updateAnalytics() {
            const records = employeeData.records;
            const startingSalary = getStartingSalary();
            
            // Filter out "New Hire" - it's the starting point, not an adjustment
            const adjustments = records.filter(r => r.reason !== 'New Hire');
            
            // Guard against no adjustments (shouldn't happen, but be safe)
            if (adjustments.length === 0) return;
            
            const raises = records.filter(r => r.changePercent > 0);
            if (raises.length === 0) return;
            
            const avgRaisePercent = raises.reduce((sum, r) => sum + r.changePercent, 0) / raises.length;
            const sortedRaises = [...raises].sort((a, b) => a.changePercent - b.changePercent);
            const medianRaise = sortedRaises[Math.floor(sortedRaises.length / 2)].changePercent;
            const largestRaise = Math.max(...raises.map(r => r.changePercent));
            const largestRaiseRecord = raises.find(r => r.changePercent === largestRaise);
            
            const meritCount = adjustments.filter(r => r.reason.includes('Merit')).length;
            
            // Use adjustments (excludes New Hire) for time between raises
            const dates = adjustments.map(r => new Date(r.date)).sort((a, b) => a - b);
            let totalDays = 0;
            for (let i = 1; i < dates.length; i++) {
                totalDays += (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
            }
            const avgMonths = dates.length > 1 ? (totalDays / (dates.length - 1)) / 30.44 : 12;
            
            document.getElementById('cagr').textContent = formatPercent(calculateCAGR());
            document.getElementById('avgRaise').textContent = formatPercent(avgRaisePercent);
            
            const avgRaiseDollar = (avgRaisePercent / 100) * getCurrentSalary();
            document.getElementById('avgRaiseDollar').textContent = state.showDollars 
                ? `~${formatCurrency(avgRaiseDollar)} per adjustment`
                : `~${((avgRaiseDollar / startingSalary) * 100).toFixed(1)} index points`;
            
            document.getElementById('medianRaise').textContent = formatPercent(medianRaise);
            document.getElementById('largestRaise').textContent = formatPercent(largestRaise);
            document.getElementById('largestRaiseDate').textContent = new Date(largestRaiseRecord.date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('avgTimeBetween').textContent = `${avgMonths.toFixed(1)} mo`;
            const benchmarkMonths = 12;
            const timeDiff = avgMonths - benchmarkMonths;
            let timeContext;
            if (timeDiff < -2) {
                timeContext = `${Math.abs(timeDiff).toFixed(1)} mo faster than typical`;
            } else if (timeDiff > 2) {
                timeContext = `${timeDiff.toFixed(1)} mo slower than typical`;
            } else {
                timeContext = `Near industry standard (12 mo)`;
            }
            document.getElementById('avgTimeDetail').textContent = timeContext;
            document.getElementById('meritCount').textContent = meritCount;
            document.getElementById('meritPercent').textContent = `${((meritCount / adjustments.length) * 100).toFixed(1)}% of all adjustments`;
        }

        // ========================================
        // PROJECTION CONTROLS
        // ========================================
        
        function setProjectionYears(years) {
            state.projectionYears = years;
            document.querySelectorAll('.interval-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.years) === years);
            });
            buildProjectionChart();
        }

        function updateCustomRate() {
            state.customRate = parseInt(document.getElementById('customRateSlider').value);
            document.getElementById('customRateValue').textContent = state.customRate + '%';
            
            buildProjectionChart();
            buildProjectionTable();
        }

        function setProjectionView(view) {
            const chartWrapper = document.getElementById('projectionChartWrapper');
            const tableWrapper = document.getElementById('projectionTableWrapper');
            const intervalButtons = document.querySelector('#tab-projections .interval-buttons');
            const buttons = document.querySelectorAll('#tab-projections .chart-type-btn');
            
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            if (view === 'chart') {
                chartWrapper.classList.remove('hidden');
                tableWrapper.classList.add('hidden');
                intervalButtons.classList.remove('hidden');
            } else {
                chartWrapper.classList.add('hidden');
                tableWrapper.classList.remove('hidden');
                intervalButtons.classList.add('hidden');
            }
        }

        function calculateTimeToTarget() {
            const target = parseFloat(document.getElementById('targetSalary').value);
            const growth = state.customRate / 100; // Use slider value
            const current = getCurrentSalary();
            
            if (target <= current) {
                document.getElementById('timeToTarget').textContent = 'Already achieved!';
                return;
            }
            
            if (growth === 0) {
                document.getElementById('timeToTarget').textContent = 'Never (0% growth)';
                return;
            }
            
            const years = Math.log(target / current) / Math.log(1 + growth);
            document.getElementById('timeToTarget').textContent = `~${years.toFixed(1)} years`;
        }

        // ========================================
        // DASHBOARD INITIALIZATION
        // ========================================
        
        function initDashboard() {
            const current = getCurrentSalary();
            const start = getStartingSalary();
            const growth = ((current - start) / start) * 100;
            const years = calculateYearsOfService();
            
            // Exclude "New Hire" from adjustment counts - it's the starting point, not an adjustment
            const adjustments = employeeData.records.filter(r => r.reason !== 'New Hire');
            const adjustmentCount = adjustments.length;
            
            document.getElementById('currentSalary').textContent = formatCurrency(current);
            document.getElementById('currentSalaryIndexed').textContent = `Index: ${formatCurrency(current, false)}`;
            document.getElementById('totalGrowth').textContent = `+${growth.toFixed(0)}%`;
            document.getElementById('yearsService').textContent = years.toFixed(1);
            document.getElementById('hireDateText').textContent = `Since ${new Date(employeeData.hireDate).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;
            document.getElementById('totalRaises').textContent = adjustmentCount;
            document.getElementById('avgRaisesPerYear').textContent = `Avg: ${(adjustmentCount / years).toFixed(1)} per year`;
            
            buildHistoryTable();
            buildMainChart();
            updateAnalytics();
            updateStory();
        }

        // ========================================
        // URL PARAMETER HANDLING
        // ========================================
        
        function updateUrlParams() {
            const params = new URLSearchParams();
            
            // Always include theme
            params.set('theme', state.theme);
            
            // Include view mode (only if not default 'dollars')
            if (!state.showDollars) {
                params.set('view', 'index');
            }
            
            // Include demo flag if in demo mode
            if (employeeData && employeeData.isDemo) {
                params.set('demo', 'true');
            }
            
            // Include tab if on dashboard and not home
            if (!document.getElementById('dashboardPage').classList.contains('hidden') && state.currentTab !== 'home') {
                params.set('tab', state.currentTab);
            }
            
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            history.replaceState(null, '', newUrl);
        }
        
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                theme: params.get('theme'),
                demo: params.get('demo') === 'true',
                tab: params.get('tab'),
                view: params.get('view')
            };
        }
        
        function initFromUrl() {
            const params = getUrlParams();
            
            // Apply theme from URL if specified
            if (params.theme && (params.theme === 'tactical' || params.theme === 'artistic')) {
                setTheme(params.theme);
            }
            
            // Apply view mode from URL if specified
            if (params.view === 'index') {
                setViewMode('index');
            }
            
            // Auto-load demo if specified
            if (params.demo) {
                loadDemoData();
                // Tab will be handled by checkInitialHash called from showDashboard
            }
        }
        
        // Initialize from URL on page load
        initFromUrl();
    </script>
</body>
</html>
